<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="google-site-verification" content="skhepgnAG24cr-ctc2IP4LZrldG8Tpq9vdmo7oJeUcA" />
<meta name="baidu-site-verification" content="X6SobJmsrZ" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />









  <link rel="alternate" href="/atom.xml" title="Phoenix">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://yoursite.com/"/>


<meta property="og:type" content="website">
<meta property="og:title" content="Phoenix">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Phoenix">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Phoenix">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: true,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> Phoenix </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Phoenix</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Phoenix</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input" />
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/03/08/Parsing-JSON-in-Swift-4-with-Decodable/">Parsing JSON in Swift 4 with Decodable</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>Trying to write a post in English. ğŸ‘»</p>
<p>Now Apple support parsing JSON directly in Swift. I write an example to show how to do.<br><a href="https://github.com/Asura19/JSONDecode" target="_blank" rel="external">Download Demo</a></p>
<h3 id="Before-Swift-4"><a href="#Before-Swift-4" class="headerlink" title="Before Swift 4"></a>Before Swift 4</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Fake datas</span></div><div class="line"><span class="keyword">let</span> aBand: [<span class="type">String</span>: <span class="type">Any</span>] = [</div><div class="line">    <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Nirvana"</span></div><div class="line">]</div><div class="line"><span class="comment">// Assume we got a response data from an api</span></div><div class="line"><span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.data(withJSONObject: aBand, options: .prettyPrinted)</div></pre></td></tr></table></figure>
<p>Object Code:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span>?</div><div class="line">    </div><div class="line">	 <span class="comment">// we need a initializer to deal with the JSON in swift 2/3 or ObjC</span></div><div class="line">    <span class="keyword">init</span>(json: [<span class="type">String</span>: <span class="type">Any</span>]) &#123;</div><div class="line">        id = json[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">Int</span> ?? -<span class="number">1</span></div><div class="line">        name = json[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is what we do in Swift 2/3 or ObjC:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> dict = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.jsonObject(with: data, options: .mutableContainers) <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="type">NSError</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">let</span> band = <span class="type">Band</span>(json: dict)</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">    <span class="built_in">print</span>(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Swift-4"><a href="#Swift-4" class="headerlink" title="Swift 4"></a>Swift 4</h3><h4 id="Dictionary-structure"><a href="#Dictionary-structure" class="headerlink" title="Dictionary structure"></a>Dictionary structure</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> aBand: [<span class="type">String</span>: <span class="type">Any</span>] = [</div><div class="line">    <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Nirvana"</span></div><div class="line">]</div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">let</span> band = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode(<span class="type">Band</span>.<span class="keyword">self</span>, from: data)</div><div class="line">    <span class="built_in">print</span>(band)</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">    <span class="built_in">print</span>(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Result: <code>Band(id: 23, name: &quot;Nirvana&quot;)</code></p>
<h4 id="Array-structure"><a href="#Array-structure" class="headerlink" title="Array structure"></a>Array structure</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> bands: [[<span class="type">String</span>: <span class="type">Any</span>]] = [</div><div class="line">    [</div><div class="line">        <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">        <span class="string">"name"</span>: <span class="string">"Nirvana"</span></div><div class="line">    ],</div><div class="line">    [</div><div class="line">        <span class="string">"id"</span>: <span class="number">22</span>,</div><div class="line">        <span class="string">"name"</span>: <span class="string">"The Beatles"</span></div><div class="line">    ]</div><div class="line">]</div></pre></td></tr></table></figure>
<p>Just change <code>Band.self</code> to <code>[Band].self</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> band = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode([<span class="type">Band</span>].<span class="keyword">self</span>, from: data)</div></pre></td></tr></table></figure>
<p>Result: <code>[JsonDecode.Band(id: 23, name: &quot;Nirvana&quot;), JsonDecode.Band(id: 22, name: &quot;The Beatles&quot;)]</code></p>
<h4 id="Nested-structure"><a href="#Nested-structure" class="headerlink" title="Nested structure"></a>Nested structure</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> type: [<span class="type">String</span>: <span class="type">Any</span>] = [</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Rock"</span>,</div><div class="line">    <span class="string">"examples"</span>: [</div><div class="line">        [</div><div class="line">            <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"Nirvana"</span></div><div class="line">        ],</div><div class="line">        [</div><div class="line">            <span class="string">"id"</span>: <span class="number">22</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"The Beatles"</span></div><div class="line">        ]</div><div class="line">    ]</div><div class="line">]</div></pre></td></tr></table></figure>
<p>Create a new type:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MusicType</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">    <span class="keyword">let</span> examples: [<span class="type">Band</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">let</span> band = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode(<span class="type">MusicType</span>.<span class="keyword">self</span>, from: data)</div><div class="line">    <span class="built_in">print</span>(band)</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">    <span class="built_in">print</span>(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Result: <code>MusicType(name: &quot;Rock&quot;, examples: [JsonDecode.Band(id: 23, name: &quot;Nirvana&quot;), JsonDecode.Band(id: 22, name: &quot;The Beatles&quot;)])</code></p>
<h4 id="Optional-field"><a href="#Optional-field" class="headerlink" title="Optional field"></a>Optional field</h4><p>What if we got a JSON like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> type: [<span class="type">String</span>: <span class="type">Any</span>] = [</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Rock"</span>,</div><div class="line">    <span class="string">"examples"</span>: [</div><div class="line">        [</div><div class="line">            <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">            <span class="comment">// "name": "Nirvana"</span></div><div class="line">        ],</div><div class="line">        [</div><div class="line">            <span class="string">"id"</span>: <span class="number">22</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"The Beatles"</span>,</div><div class="line">            <span class="string">"country"</span>: <span class="string">"UK"</span></div><div class="line">        ]</div><div class="line">    ]</div><div class="line">]</div></pre></td></tr></table></figure>
<p>OK, obviously the decoder will ignore the â€œcountryâ€ key, but can not find the key â€œnameâ€, we will get a error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">keyNotFound(CodingKeys(stringValue: &quot;name&quot;, intValue: nil), </div><div class="line">Swift.DecodingError.Context(codingPath: </div><div class="line">[CodingKeys(stringValue: &quot;examples&quot;, intValue: nil), _JSONKey(stringValue: &quot;Index 0&quot;, intValue: 0)],</div><div class="line">debugDescription: &quot;No value associated with key CodingKeys(stringValue: \&quot;name\&quot;, intValue: nil) (\&quot;name\&quot;).&quot;, </div><div class="line">underlyingError: nil))</div></pre></td></tr></table></figure>
<p>All we need to do is to make the <code>name</code> property to Optional:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span>?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Result: <code>MusicType(name: &quot;Rock&quot;, examples: [JsonDecode.Band(id: 23, name: nil), JsonDecode.Band(id: 22, name: Optional(&quot;The Beatles&quot;))])</code></p>
<h4 id="Custom-keys"><a href="#Custom-keys" class="headerlink" title="Custom keys"></a>Custom keys</h4><p>If the field in JSON is not what we want:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> aBand: [<span class="type">String</span>: <span class="type">Any</span>] = [</div><div class="line">    <span class="string">"id"</span>: <span class="number">23</span>,</div><div class="line">    <span class="string">"band_name"</span>: <span class="string">"Nirvana"</span></div><div class="line">]</div></pre></td></tr></table></figure>
<p>We need to define a nested enum in our type called â€œCodingKeysâ€ (or use a typealias with this name) that conforms to the CodingKey protocol â€“ Swift will automatically use this as the key type. This therefore allows you to easily customise the keys that your properties are decoded with.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">enum</span> <span class="title">CodingKeys</span> : <span class="title">String</span>, <span class="title">CodingKey</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> id</div><div class="line">        <span class="keyword">case</span> name = <span class="string">"band_name"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Results: <code>Band(id: 23, name: &quot;Nirvana&quot;)</code></p>
<p>But we need to write all the other properties in the enum, what we expected is adding others automatically in compiling time.<br>And also we expect a many-to-one ability, like <code>&quot;band_name&quot; | &quot;bandName&quot; =&gt; name</code>.<br>Hope Apple to update.</p>
<blockquote>
<p>Update on 30th March, 2018 for Swift 4.1</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Band</span>: <span class="title">Decodable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></div><div class="line">    <span class="keyword">let</span> bandName: <span class="type">String</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</div><div class="line">decoder.keyDecodingStrategy = .convertFromSnakeCase</div><div class="line"><span class="keyword">let</span> band = <span class="keyword">try</span>! decoder.decode(<span class="type">Band</span>.<span class="keyword">self</span>, from: data)</div></pre></td></tr></table></figure>
<p>Results: <code>Band(id: 23, name: &quot;Nirvana&quot;)</code></p>
<h4 id="Encode"><a href="#Encode" class="headerlink" title="Encode"></a>Encode</h4><p>Same like <code>Decodable</code>, We can use <code>Encodable</code>, or just use <code>Codable</code> </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Codable</span> = <span class="type">Decodable</span> &amp; <span class="type">Encodable</span></div></pre></td></tr></table></figure>
<p><strong>__Original articles, please indicate the source if you reproduced it.</strong></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/03/06/iOSä¸­æ•è·exceptionå’Œsignal/">iOSä¸­æ•è·exceptionå’Œsignal</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 6, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>Crashåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç¨‹åºæŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ²¡æœ‰è¢«æ•è·é€ æˆçš„ï¼›å¦ä¸€ç§æ˜¯signalç±»å‹çš„å¼‚å¸¸ã€‚é’ˆå¯¹æœªè¢«æ•è·çš„å¼‚å¸¸å¯ä»¥ä½¿ç”¨NSSetUncaughtExceptionHandlerç³»ç»Ÿæ–¹æ³•æ¥è®¾ç½®å¼‚å¸¸å¤„ç†å‡½æ•°ï¼›å¯¹äºsignalç±»å‹çš„å¼‚å¸¸ï¼Œéœ€è¦ä½¿ç”¨signalç³»ç»Ÿæ–¹æ³•ç»™æ¯ç§éœ€è¦å¤„ç†çš„signalç±»å‹çš„å¼‚å¸¸è®¾ç½®å¤„ç†å‡½æ•°ã€‚<a href="https://github.com/Asura19/UncaughtException" target="_blank" rel="external">æœ¬æ–‡Demo</a></p>
<h2 id="æ ¸å¿ƒä»£ç "><a href="#æ ¸å¿ƒä»£ç " class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h2><h3 id="æ•è·exception"><a href="#æ•è·exception" class="headerlink" title="æ•è·exception"></a>æ•è·exception</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">void HandleException(NSException *exception) &#123;</div><div class="line"></div><div class="line">    NSArray *stackArray = [exception callStackSymbols];</div><div class="line">    NSString *reason = [exception reason];</div><div class="line">    NSString *name = [exception name];</div><div class="line">    NSString *exceptionInfo = [NSString stringWithFormat:@&quot;Exception reasonï¼š%@\nException nameï¼š%@\nException stackï¼š%@&quot;,name, reason, stackArray];</div><div class="line">    </div><div class="line">    NSLog(@&quot;%@&quot;, exceptionInfo);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">void InstallUncaughtExceptionHandler(void) &#123;</div><div class="line">    NSSetUncaughtExceptionHandler(&amp;HandleException);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ•è·Signal"><a href="#æ•è·Signal" class="headerlink" title="æ•è·Signal"></a>æ•è·Signal</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">void SignalExceptionHandler(int signal) &#123;</div><div class="line">    NSMutableString *crashInfo = [[NSMutableString alloc] init];</div><div class="line">    [crashInfo appendString:@&quot;Stack:\n&quot;];</div><div class="line">    void *callstack[128];</div><div class="line">    int i, frames = backtrace(callstack, 128);</div><div class="line">    char **strs = backtrace_symbols(callstack, frames);</div><div class="line">    for (i = 0; i &lt; frames; ++i) &#123;</div><div class="line">        [crashInfo appendFormat:@&quot;%s\n&quot;, strs[i]];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void InstallSignalHandler(void) &#123;</div><div class="line">    signal(SIGHUP, SignalExceptionHandler);</div><div class="line">    signal(SIGINT, SignalExceptionHandler);</div><div class="line">    signal(SIGQUIT, SignalExceptionHandler);</div><div class="line">    signal(SIGABRT, SignalExceptionHandler);</div><div class="line">    signal(SIGILL, SignalExceptionHandler);</div><div class="line">    signal(SIGSEGV, SignalExceptionHandler);</div><div class="line">    signal(SIGFPE, SignalExceptionHandler);</div><div class="line">    signal(SIGBUS, SignalExceptionHandler);</div><div class="line">    signal(SIGPIPE, SignalExceptionHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Signalä¿¡å·ç±»å‹"><a href="#Signalä¿¡å·ç±»å‹" class="headerlink" title="Signalä¿¡å·ç±»å‹"></a><a href="https://opensource.apple.com/source/xnu/xnu-344/bsd/sys/signal.h" target="_blank" rel="external">Signalä¿¡å·ç±»å‹</a></h2><p><strong>define SIGHUP 1 /<em> hangup </em>/</strong><br>SIGHUPæ˜¯Unixç³»ç»Ÿç®¡ç†å‘˜å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªä¿¡å·ã€‚è®¸å¤šåå°æœåŠ¡è¿›ç¨‹åœ¨æ¥å—åˆ°è¯¥ä¿¡å·åå°†ä¼šé‡æ–°è¯»å–å®ƒä»¬çš„é…ç½®æ–‡ä»¶ã€‚ç„¶è€Œï¼Œè¯¥ä¿¡å·çš„å®é™…åŠŸèƒ½æ˜¯é€šçŸ¥è¿›ç¨‹å®ƒçš„æ§åˆ¶ç»ˆç«¯è¢«æ–­å¼€ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGINT 2 /<em> interrupt </em>/</strong><br>å¯¹äºUnixä½¿ç”¨è€…æ¥è¯´ï¼ŒSIGINTæ˜¯å¦å¤–ä¸€ä¸ªå¸¸ç”¨çš„ä¿¡å·ã€‚è®¸å¤šshellçš„CTRL-Cç»„åˆä½¿å¾—è¿™ä¸ªä¿¡å·è¢«å¤§å®¶æ‰€ç†ŸçŸ¥ã€‚è¯¥ä¿¡å·çš„æ­£å¼åå­—æ˜¯ä¸­æ–­ä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGQUIT 3 /<em> quit </em>/</strong><br>SIGQUITä¿¡å·è¢«ç”¨äºæ¥æ”¶shellçš„CTRL-/ç»„åˆã€‚å¦å¤–ï¼Œå®ƒè¿˜ç”¨äºå‘ŠçŸ¥è¿›ç¨‹é€€å‡ºã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨ä¿¡å·ï¼Œç”¨æ¥é€šçŸ¥åº”ç”¨ç¨‹åºä»å®¹çš„ï¼ˆè¯‘æ³¨:å³åœ¨ç»“æŸå‰æ‰§è¡Œä¸€äº›é€€å‡ºåŠ¨ä½œï¼‰å…³é—­ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGILL 4 /<em> illegal instr. (not reset when caught) </em>/</strong><br>å¦‚æœæ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ä¸­åŒ…å«éæ³•æŒ‡ä»¤ï¼Œæ“ä½œç³»ç»Ÿå°†å‘è¯¥è¿›ç¨‹å‘é€SIGILLä¿¡å·ã€‚å¦‚æœä½ çš„ç¨‹åºä½¿ç”¨äº†çº¿ç¨‹ï¼Œæˆ–è€…pointer functionsï¼Œé‚£ä¹ˆå¯èƒ½çš„è¯å¯ä»¥å°è¯•æ•è·è¯¥ä¿¡å·æ¥ååŠ©è°ƒè¯•ã€‚ï¼ˆ[color=Red]æ³¨æ„ï¼šåŸæ–‡è¿™å¥ä¸ºï¼šâ€œIf your program makes use of use of threads, or pointer functions, try to catch this signal if possible for aid in debugging.â€ã€‚ä¸­é—´çš„ä¸¤ä¸ªuse of use ofï¼Œä¸çŸ¥æ˜¯åŸä¹¦æ’ç‰ˆçš„ç‘•ç–µè¿˜æ˜¯æˆ‘ç¡®å®æ²¡æœ‰æ˜ç™½å…¶æ„ä¹‰ï¼›å¦å¤–ï¼Œå¶ç»å¸¸å¬è¯´functions pointerï¼Œå¯¹äºpointer functionsï¼Œgoogleäº†ä¸€ä¸‹ï¼Œåº”è¯¥æ˜¯fortrané‡Œé¢çš„ä¸œè¥¿ï¼Œä¸ç®¡æ€æ ·ï¼Œè¿˜çœŸä¸çŸ¥é“ï¼Œç¡®åˆ‡å«ä¹‰è¿˜è¯·çŸ¥é“çš„å…„å¼Ÿæ–§æ­£ã€‚[/color]ï¼‰ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGTRAP 5 /<em> trace trap (not reset when caught) </em>/</strong><br>SIGTRAPè¿™ä¸ªä¿¡å·æ˜¯ç”±POSIXæ ‡å‡†å®šä¹‰çš„ï¼Œç”¨äºè°ƒè¯•ç›®çš„ã€‚å½“è¢«è°ƒè¯•è¿›ç¨‹æ¥æ”¶åˆ°è¯¥ä¿¡å·æ—¶ï¼Œå°±æ„å‘³ç€å®ƒåˆ°è¾¾äº†æŸä¸€ä¸ªè°ƒè¯•æ–­ç‚¹ã€‚ä¸€æ—¦è¿™ä¸ªä¿¡å·è¢«äº¤ä»˜ï¼Œè¢«è°ƒè¯•çš„è¿›ç¨‹å°±ä¼šåœæ­¢ï¼Œå¹¶ä¸”å®ƒçš„çˆ¶è¿›ç¨‹å°†æ¥åˆ°é€šçŸ¥ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGABRT 6 /<em> abort() </em>/</strong><br>SIGABRTæä¾›äº†ä¸€ç§åœ¨å¼‚å¸¸ç»ˆæ­¢(abort)ä¸€ä¸ªè¿›ç¨‹çš„åŒæ—¶åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨çš„æ–¹æ³•ã€‚ç„¶è€Œå¦‚æœè¯¥ä¿¡å·è¢«æ•è·ï¼Œå¹¶ä¸”ä¿¡å·å¤„ç†å¥æŸ„æ²¡æœ‰è¿”å›ï¼Œé‚£ä¹ˆè¿›ç¨‹ä¸ä¼šç»ˆæ­¢ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGFPE 8 /<em> floating point exception </em>/</strong><br>å½“è¿›ç¨‹å‘ç”Ÿä¸€ä¸ªæµ®ç‚¹é”™è¯¯æ—¶ï¼ŒSIGFPEä¿¡å·è¢«å‘é€ç»™è¯¥è¿›ç¨‹ã€‚å¯¹äºé‚£äº›å¤„ç†å¤æ‚æ•°å­¦è¿ç®—çš„ç¨‹åºï¼Œä¸€èˆ¬ä¼šå»ºè®®ä½ æ•è·è¯¥ä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGKILL 9 /<em> kill (cannot be caught or ignored) </em>/</strong><br>SIGKILLæ˜¯è¿™äº›ä¿¡å·ä¸­æœ€éš¾å¯¹ä»˜çš„ä¸€ä¸ªã€‚æ­£å¦‚ä½ åœ¨å®ƒæ—è¾¹çš„æ³¨é‡Šä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™ä¸ªä¿¡å·ä¸èƒ½è¢«æ•è·æˆ–å¿½ç•¥ã€‚ä¸€æ—¦è¯¥ä¿¡å·è¢«äº¤ä»˜ç»™ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹å°±ä¼šç»ˆæ­¢ã€‚ç„¶è€Œï¼Œä¼šæœ‰ä¸€äº›æå°‘æ•°æƒ…å†µSIGKILLä¸ä¼šç»ˆæ­¢è¿›ç¨‹ã€‚è¿™äº›ç½•è§çš„æƒ…å½¢åœ¨å¤„ç†ä¸€ä¸ªâ€œéä¸­æ–­æ“ä½œâ€ï¼ˆæ¯”å¦‚ç£ç›˜I/Oï¼‰çš„æ—¶å€™å‘ç”Ÿã€‚è™½ç„¶è¿™æ ·çš„æƒ…å½¢æå°‘å‘ç”Ÿï¼Œç„¶è€Œä¸€æ—¦å‘ç”Ÿçš„è¯ï¼Œä¼šé€ æˆè¿›ç¨‹æ­»é”ã€‚å”¯ä¸€ç»“æŸè¿›ç¨‹çš„åŠæ³•å°±åªæœ‰é‡æ–°å¯åŠ¨äº†ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGBUS 10 /<em> bus error </em>/</strong><br>å¦‚åŒå®ƒçš„åå­—æš—ç¤ºçš„é‚£æ ·ï¼ŒCPUæ£€æµ‹åˆ°æ•°æ®æ€»çº¿ä¸Šçš„é”™è¯¯æ—¶å°†äº§ç”ŸSIGBUSä¿¡å·ã€‚å½“ç¨‹åºå°è¯•å»è®¿é—®ä¸€ä¸ªæ²¡æœ‰æ­£ç¡®å¯¹é½çš„å†…å­˜åœ°å€æ—¶å°±ä¼šäº§ç”Ÿè¯¥ä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGSEGV 11 /<em> segmentation violation </em>/</strong><br>SIGSEGVæ˜¯å¦ä¸€ä¸ªC/C++ç¨‹åºå‘˜å¾ˆç†Ÿæ‚‰çš„ä¿¡å·ã€‚å½“ç¨‹åºæ²¡æœ‰æƒåˆ©è®¿é—®ä¸€ä¸ªå—ä¿æŠ¤çš„å†…å­˜åœ°å€æ—¶ï¼Œæˆ–è€…è®¿é—®æ— æ•ˆçš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼ˆè„æŒ‡é’ˆï¼Œdirty pointersï¼Œè¯‘æ³¨ï¼šç”±äºæ²¡æœ‰å’Œåå¤‡å­˜å‚¨å™¨ä¸­å†…å®¹è¿›è¡ŒåŒæ­¥è€Œé€ æˆã€‚å…³äºé‡æŒ‡é’ˆï¼Œå¯ä»¥å‚è§<a href="http://en.wikipedia.org/wiki/Wild_pointer" target="_blank" rel="external">http://en.wikipedia.org/wiki/Wild_pointer</a> çš„è§£é‡Šã€‚ï¼‰æ—¶ï¼Œä¼šäº§ç”Ÿè¿™ä¸ªä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGSYS 12 /<em> non-existent system call invoked </em>/</strong><br>SIGSYSä¿¡å·ä¼šåœ¨è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªä¸å­˜åœ¨çš„ç³»ç»Ÿè°ƒç”¨æ—¶è¢«äº¤ä»˜ã€‚æ“ä½œç³»ç»Ÿä¼šäº¤ä»˜è¯¥ä¿¡å·ï¼Œå¹¶ä¸”è¿›ç¨‹ä¼šè¢«ç»ˆæ­¢ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚</p>
<p><strong>define SIGPIPE 13 /<em> write on a pipe with no one to read it </em>/</strong><br>ç®¡é“çš„ä½œç”¨å°±åƒç”µè¯ä¸€æ ·ï¼Œå…è®¸è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å¦‚æœè¿›ç¨‹å°è¯•å¯¹ç®¡é“æ‰§è¡Œå†™æ“ä½œï¼Œç„¶è€Œç®¡é“çš„å¦ä¸€è¾¹å´æ²¡æœ‰å›åº”è€…æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†SIGPIPEä¿¡å·äº¤ä»˜ç»™è¿™ä¸ªè®¨åŒçš„è¿›ç¨‹ï¼ˆè¿™é‡Œå°±æ˜¯é‚£ä¸ªæ‰“ç®—å†™å…¥çš„è¿›ç¨‹ï¼‰ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGALRM 14 /<em> alarm clock </em>/</strong><br>åœ¨è¿›ç¨‹çš„è®¡æ—¶å™¨åˆ°æœŸçš„æ—¶å€™ï¼ŒSIGALRMä¿¡å·ä¼šè¢«äº¤ä»˜ï¼ˆdeliveredï¼‰ç»™è¿›ç¨‹ã€‚è¿™äº›è®¡æ—¶å™¨ç”±æœ¬ç« åé¢å°†ä¼šæåŠ<br>çš„setitimerå’Œalarmè°ƒç”¨è®¾ç½®ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGTERM 15 /<em> software termination signal from kill </em>/</strong><br>SIGTERMä¿¡å·è¢«å‘é€ç»™è¿›ç¨‹ï¼Œé€šçŸ¥è¯¥è¿›ç¨‹æ˜¯æ—¶å€™ç»ˆæ­¢äº†ï¼Œå¹¶ä¸”åœ¨ç»ˆæ­¢ä¹‹å‰åšä¸€äº›æ¸…ç†æ´»åŠ¨ã€‚SIGTERMä¿¡å·æ˜¯Unixçš„killå‘½ä»¤å‘é€çš„ç¼ºçœä¿¡å·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿå…³é—­æ—¶å‘è¿›ç¨‹å‘é€çš„ç¼ºçœä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGURG 16 /<em> urgent condition on IO channel </em>/</strong><br>åœ¨è¿›ç¨‹å·²æ‰“å¼€çš„å¥—æ¥å­—ä¸Šå‘ç”ŸæŸäº›æƒ…å†µæ—¶ï¼ŒSIGURGå°†è¢«å‘é€ç»™è¯¥è¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹ä¸æ•è·è¿™ä¸ªä¿¡å·çš„è¯ï¼Œé‚£ä¹ˆå°†è¢«ä¸¢å¼ƒã€‚ç¼ºçœè¡Œä¸ºæ˜¯ä¸¢å¼ƒè¿™ä¸ªä¿¡å·ã€‚</p>
<p><strong>define SIGSTOP 17 /<em> sendable stop signal not from tty </em>/</strong><br>æœ¬ä¿¡å·ä¸èƒ½è¢«æ•è·æˆ–å¿½ç•¥ã€‚ä¸€æ—¦è¿›ç¨‹æ¥æ”¶åˆ°SIGSTOPä¿¡å·ï¼Œå®ƒä¼šç«‹å³åœæ­¢(stop)ï¼Œç›´åˆ°æ¥æ”¶åˆ°å¦ä¸€ä¸ªSIGCONT<br>ä¿¡å·ä¸ºæ­¢ã€‚ç¼ºçœè¡Œä¸ºæ˜¯åœæ­¢è¿›ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªSIGCONTä¿¡å·ä¸ºæ­¢ã€‚</p>
<p><strong>define SIGTSTP 18 /<em> stop signal from tty </em>/</strong><br>SIGSTPä¸SIGSTOPç±»ä¼¼ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºSIGSTPä¿¡å·å¯ä»¥è¢«æ•è·æˆ–å¿½ç•¥ã€‚å½“shellä»é”®ç›˜æ¥æ”¶åˆ°CTRL-Zçš„æ—¶å€™å°±ä¼šäº¤ä»˜ï¼ˆdeliverï¼‰è¿™ä¸ªä¿¡å·ç»™è¿›ç¨‹ã€‚ç¼ºçœè¡Œä¸ºæ˜¯åœæ­¢è¿›ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªSIGCONTä¿¡å·ä¸ºæ­¢ã€‚</p>
<p><strong>define SIGCONT 19 /<em> continue a stopped process </em>/</strong><br>SIGCONTä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„ä¿¡å·ã€‚å¦‚å‰æ‰€è¿°ï¼Œå½“è¿›ç¨‹åœæ­¢çš„æ—¶å€™ï¼Œè¿™ä¸ªä¿¡å·ç”¨æ¥å‘Šè¯‰è¿›ç¨‹æ¢å¤è¿è¡Œã€‚è¯¥ä¿¡å·çš„æœ‰è¶£çš„åœ°æ–¹åœ¨äºï¼šå®ƒä¸èƒ½è¢«å¿½ç•¥æˆ–é˜»å¡ï¼Œä½†å¯ä»¥è¢«æ•è·ã€‚è¿™æ ·åšå¾ˆæœ‰æ„ä¹‰ï¼šå› ä¸ºè¿›ç¨‹å¤§æ¦‚ä¸æ„¿æ„å¿½ç•¥æˆ–é˜»å¡SIGCONTä¿¡å·ï¼Œå¦åˆ™ï¼Œå¦‚æœè¿›ç¨‹æ¥æ”¶åˆ°SIGSTOPæˆ–SIGSTPçš„æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿç¼ºçœè¡Œä¸ºæ˜¯ä¸¢å¼ƒè¯¥ä¿¡å·ã€‚</p>
<p><strong>define SIGCHLD 20 /<em> to parent on child stop or exit </em>/</strong><br>SIGCHLDæ˜¯ç”±Berkeley Unixå¼•å…¥çš„ï¼Œå¹¶ä¸”æ¯”SRV 4 Unixä¸Šçš„å®ç°æœ‰æ›´å¥½çš„æ¥å£ã€‚ï¼ˆå¦‚æœä¿¡å·æ˜¯ä¸€ä¸ªæ²¡æœ‰è¿½æº¯èƒ½åŠ›çš„è¿‡ç¨‹(not a retroactive process)ï¼Œé‚£ä¹ˆBSDçš„SIGCHIDä¿¡å·å®ç°ä¼šæ¯”è¾ƒå¥½ã€‚åœ¨system V Unixçš„å®ç°ä¸­ï¼Œå¦‚æœè¿›ç¨‹è¦æ±‚æ•è·è¯¥ä¿¡å·ï¼Œæ“ä½œç³»ç»Ÿä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰ä»»ä½•æœªå®Œæˆçš„å­è¿›ç¨‹ï¼ˆè¿™äº›å­è¿›ç¨‹æ˜¯å·²ç»é€€å‡ºexit)çš„å­è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨ç­‰å¾…è°ƒç”¨waitçš„çˆ¶è¿›ç¨‹æ”¶é›†å®ƒä»¬çš„çŠ¶æ€ï¼‰ã€‚å¦‚æœå­è¿›ç¨‹é€€å‡ºçš„æ—¶å€™é™„å¸¦æœ‰ä¸€äº›ç»ˆæ­¢ä¿¡æ¯(terminating informationï¼‰ï¼Œé‚£ä¹ˆä¿¡å·å¤„ç†å¥æŸ„å°±ä¼šè¢«è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œä»…ä»…è¦æ±‚æ•è·è¿™ä¸ªä¿¡å·ä¼šå¯¼è‡´ä¿¡å·å¤„ç†å¥æŸ„è¢«è°ƒç”¨(è¯‘æ³¨ï¼šå³æ˜¯ä¸Šé¢è¯´çš„â€œä¿¡å·çš„è¿½æº¯èƒ½åŠ›â€)ï¼Œè€Œè¿™æ˜¯å´ä¸€ç§ç›¸å½“æ··ä¹±çš„çŠ¶å†µã€‚ï¼‰ä¸€æ—¦ä¸€ä¸ªè¿›ç¨‹çš„å­è¿›ç¨‹çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼ŒSIGCHLDä¿¡å·å°±ä¼šè¢«å‘é€ç»™è¯¥è¿›ç¨‹ã€‚å°±åƒæˆ‘åœ¨å‰é¢ç« èŠ‚æåˆ°çš„ï¼Œçˆ¶è¿›ç¨‹è™½ç„¶å¯ä»¥forkå‡ºå­è¿›ç¨‹ï¼Œä½†æ²¡æœ‰å¿…è¦ç­‰å¾…å­è¿›ç¨‹é€€å‡ºã€‚ä¸€èˆ¬æ¥è¯´è¿™æ˜¯ä¸å¤ªå¥½çš„ï¼Œå› ä¸ºè¿™æ ·çš„è¯ï¼Œä¸€æ—¦è¿›ç¨‹é€€å‡ºå°±å¯èƒ½ä¼šå˜æˆä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚å¯æ˜¯å¦‚æœçˆ¶è¿›ç¨‹æ•è·SIGCHLDä¿¡å·çš„è¯ï¼Œå®ƒå°±å¯ä»¥ä½¿ç”¨waitç³»åˆ—è°ƒç”¨ä¸­çš„æŸä¸€ä¸ªå»æ”¶é›†å­è¿›ç¨‹çŠ¶æ€ï¼Œæˆ–è€…åˆ¤æ–­å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚å½“å‘é€SIGSTOP,SIGSTPæˆ–SIGCONFä¿¡å·ç»™å­è¿›ç¨‹æ—¶ï¼ŒSIGCHLDä¿¡å·ä¹Ÿä¼šè¢«å‘é€ç»™çˆ¶è¿›ç¨‹ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ä¸¢å¼ƒè¯¥ä¿¡å·ã€‚</p>
<p><strong>define SIGTTIN 21 /<em> to readers pgrp upon background tty read </em>/</strong><br>å½“ä¸€ä¸ªåå°è¿›ç¨‹å°è¯•è¿›è¡Œä¸€ä¸ªè¯»æ“ä½œæ—¶ï¼ŒSIGTTINä¿¡å·è¢«å‘é€ç»™è¯¥è¿›ç¨‹ã€‚è¿›ç¨‹å°†ä¼šé˜»å¡ç›´åˆ°æ¥æ”¶åˆ°SIGCONTä¿¡å·ä¸ºæ­¢ã€‚ç¼ºçœè¡Œä¸ºæ˜¯åœæ­¢è¿›ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°SIGCONTä¿¡å·ã€‚</p>
<p><strong>define SIGTTOU 22 /<em> like TTIN if (tp-&gt;t_local&amp;LTOSTOP) </em>/</strong><br>SIGTTOUä¿¡å·ä¸SIGTTINå¾ˆç›¸ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºSIGTTOUä¿¡å·æ˜¯ç”±äºåå°è¿›ç¨‹å°è¯•å¯¹ä¸€ä¸ªè®¾ç½®äº†TOSTOPå±æ€§çš„ttyæ‰§è¡Œå†™æ“ä½œæ—¶æ‰ä¼šäº§ç”Ÿã€‚ç„¶è€Œï¼Œå¦‚æœttyæ²¡æœ‰è®¾ç½®è¿™ä¸ªå±æ€§ï¼ŒSIGTTOUå°±ä¸ä¼šè¢«å‘é€ã€‚ç¼ºçœè¡Œä¸ºæ˜¯åœæ­¢è¿›ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°SIGCONTä¿¡å·ã€‚</p>
<p><strong>define SIGIO 23 /<em> input/output possible signal </em>/</strong><br>å¦‚æœè¿›ç¨‹åœ¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰I/Oæ“ä½œçš„è¯ï¼ŒSIGIOä¿¡å·å°†è¢«å‘é€ç»™è¿™ä¸ªè¿›ç¨‹ã€‚è¿›ç¨‹å¯ä»¥é€šè¿‡fcntlè°ƒç”¨æ¥è®¾ç½®ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ä¸¢å¼ƒè¯¥ä¿¡å·ã€‚</p>
<p><strong>define SIGXCPU 24 /<em> exceeded CPU time limit </em>/</strong><br>å¦‚æœä¸€æ—¦è¿›ç¨‹è¶…å‡ºäº†å®ƒå¯ä»¥ä½¿ç”¨çš„CPUé™åˆ¶ï¼ˆCPU limitï¼‰ï¼ŒSIGXCPUä¿¡å·å°±è¢«å‘é€ç»™å®ƒã€‚è¿™ä¸ªé™åˆ¶å¯ä»¥ä½¿ç”¨éšåè®¨è®ºçš„setrlimitè®¾ç½®ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGXFSZ 25 /<em> exceeded file size limit </em>/</strong><br>å¦‚æœä¸€æ—¦è¿›ç¨‹è¶…å‡ºäº†å®ƒå¯ä»¥ä½¿ç”¨çš„æ–‡ä»¶å¤§å°é™åˆ¶ï¼ŒSIGXFSZä¿¡å·å°±è¢«å‘é€ç»™å®ƒã€‚ç¨åæˆ‘ä»¬ä¼šç»§ç»­è®¨è®ºè¿™ä¸ªä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGVTALRM 26 /<em> virtual time alarm </em>/</strong><br>å¦‚æœä¸€æ—¦è¿›ç¨‹è¶…è¿‡äº†å®ƒè®¾å®šçš„è™šæ‹Ÿè®¡æ—¶å™¨è®¡æ•°æ—¶ï¼ŒSIGVTALRMä¿¡å·å°±è¢«å‘é€ç»™å®ƒã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGPROF 27 /<em> profiling time alarm </em>/</strong><br>å½“è®¾ç½®äº†è®¡æ—¶å™¨æ—¶ï¼ŒSIGPROFæ˜¯å¦ä¸€ä¸ªå°†ä¼šå‘é€ç»™è¿›ç¨‹çš„ä¿¡å·ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p><strong>define SIGWINCH 28 /<em> window size changes </em>/</strong><br>å½“è¿›ç¨‹è°ƒæ•´äº†ç»ˆç«¯çš„è¡Œæˆ–åˆ—æ—¶ï¼ˆæ¯”å¦‚å¢å¤§ä½ çš„xtermçš„å°ºå¯¸ï¼‰ï¼ŒSIGWINCHä¿¡å·è¢«å‘é€ç»™è¯¥è¿›ç¨‹ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ä¸¢å¼ƒè¯¥ä¿¡å·ã€‚</p>
<p><strong>define SIGUSR1 29 /<em> user defined signal 1 </em>/</strong><br><strong>define SIGUSR2 30 /<em> user defined signal 2 </em>/</strong><br>SIGUSR1å’ŒSIGUSR2è¿™ä¸¤ä¸ªä¿¡å·è¢«è®¾è®¡ä¸ºç”¨æˆ·æŒ‡å®šã€‚å®ƒä»¬å¯ä»¥è¢«è®¾å®šæ¥å®Œæˆä½ çš„ä»»ä½•éœ€è¦ã€‚æ¢å¥è¯è¯´ï¼Œæ“ä½œç³»ç»Ÿæ²¡æœ‰ä»»ä½•è¡Œä¸ºä¸è¿™ä¸¤ä¸ªä¿¡å·å…³è”ã€‚ç¼ºçœè¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚(è¯‘æ³¨ï¼šæŒ‰åŸæ–‡çš„æ„æ€ç¿»è¯‘å‡ºæ¥ä¼¼ä¹è¿™ä¸¤å¥è¯æœ‰ç‚¹çŸ›ç›¾ã€‚)</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/03/01/Objective-C-ä¸­çš„æ¶ˆæ¯å‘é€å’Œè½¬å‘/">Objective-C ä¸­çš„æ¶ˆæ¯å‘é€å’Œè½¬å‘</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 1, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>Objective-C çš„æ–¹æ³•è°ƒç”¨è¢«è‹¹æœæˆä¸ºâ€å‘æ¶ˆæ¯â€. objcçš„æ¶ˆæ¯æœºåˆ¶æ˜¯ç”±è¿è¡Œæ—¶å®ç°ã€éå¸¸çµæ´»åŠ¨æ€ã€‚è¿™ç¯‡æ–‡ç« ç®€å•è®°å½•ä¸€ä¸‹objcè¿è¡Œæ—¶å¯¹äºæ¶ˆæ¯å‘é€å’Œè½¬å‘çš„å®ç°. <a href="https://github.com/Asura19/ObjcMessageDemo" target="_blank" rel="external">æœ¬æ–‡Demo</a></p>
<h2 id="ç¼–è¯‘å™¨è½¬æ¢"><a href="#ç¼–è¯‘å™¨è½¬æ¢" class="headerlink" title="ç¼–è¯‘å™¨è½¬æ¢"></a>ç¼–è¯‘å™¨è½¬æ¢</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[cat mew];</div></pre></td></tr></table></figure>
<p>æ„ä¸ºcatå¯¹è±¡è°ƒç”¨mewæ–¹æ³•, ä¹Ÿå°±æ˜¯å‘catå¯¹è±¡å‘é€mewæ¶ˆæ¯, å®é™…ä¸Šç¼–è¯‘å™¨ä¼šå°†è¿™è¡Œä»£ç è½¬æ¢ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSend(cat, @selector(mew));</div></pre></td></tr></table></figure>
<p>éªŒè¯å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#import &lt;objc/message.h&gt;</div><div class="line"></div><div class="line">@interface Cat : NSObject</div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">- (void)mew;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Cat</div><div class="line">- (void)mew &#123;</div><div class="line">    NSLog(@&quot;å–µ~&quot;);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">       Cat *cat = Cat.new;</div><div class="line">       [cat mew];</div><div class="line">       objc_msgSend(cat, @selector(mew));</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»“æœæ˜¯è¾“å‡ºä¸¤æ¬¡:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">å–µ~</div><div class="line">å–µ~</div></pre></td></tr></table></figure>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡Œ <code>clang -rewrite-objc main.m</code> å°†ocè½¬æ¢ä¸ºC++ä»£ç æ¥æŸ¥çœ‹.</p>
<h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h2><p><a href="https://developer.apple.com/documentation/objectivec/1456712-objc_msgsend?language=occ" target="_blank" rel="external">æ–‡æ¡£</a>ä¸­è¿™æ ·å†™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">id objc_msgSend(id self, SEL _cmd, ...)</div></pre></td></tr></table></figure>
<p>å°†ä¸€ä¸ªæ¶ˆæ¯å‘é€ç»™ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå€¼ã€‚<br>å…¶ä¸­ï¼Œselfæ˜¯æ¶ˆæ¯çš„æ¥å—è€…ï¼Œ_cmdæ˜¯selectorï¼Œ â€¦æ˜¯å¯å˜å‚æ•°åˆ—è¡¨ã€‚</p>
<p>ä¸ºäº†äº†è§£objc_msgSendæ–¹æ³•åšäº†ä»€ä¹ˆï¼Œè¿™é‡Œéœ€è¦æŸ¥çœ‹ä¸€ä¸‹objc runtimeçš„<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">æºç </a><br>é¦–å…ˆ runtimeå®šä¹‰äº†å¦‚ä¸‹çš„æ•°æ®ç±»å‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_class *Class;</div><div class="line">typedef struct objc_object *id;</div><div class="line"></div><div class="line">struct objc_object &#123;</div><div class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct objc_class : objc_object  &#123;</div><div class="line">    Class superclass;</div><div class="line">    cache_t cache;             // æ–¹æ³•ç¼“å­˜</div><div class="line">    class_data_bits_t bits;    // ç±»å…·ä½“çš„ä¿¡æ¯</div><div class="line"></div><div class="line">    class_rw_t *data() &#123; </div><div class="line">        return bits.data();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">struct class_rw_t &#123;</div><div class="line">    // Be warned that Symbolication knows the layout of this structure.</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t version;</div><div class="line"></div><div class="line">    const class_ro_t *ro;</div><div class="line"></div><div class="line">    method_array_t methods; // æ–¹æ³•åˆ—è¡¨</div><div class="line">    property_array_t properties; // å±æ€§åˆ—è¡¨</div><div class="line">    protocol_array_t protocols; // åè®®åˆ—è¡¨</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct class_ro_t &#123;</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t instanceStart;</div><div class="line">    uint32_t instanceSize; // å¯¹è±¡å ç”¨ç©ºé—´</div><div class="line">#ifdef __LP64__</div><div class="line">    uint32_t reserved;</div><div class="line">#endif</div><div class="line"></div><div class="line">    const uint8_t * ivarLayout;</div><div class="line">    </div><div class="line">    const char * name; // ç±»å</div><div class="line">    method_list_t * baseMethodList;</div><div class="line">    protocol_list_t * baseProtocols;</div><div class="line">    const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨</div><div class="line"></div><div class="line">    const uint8_t * weakIvarLayout;</div><div class="line">    property_list_t *baseProperties;</div><div class="line"></div><div class="line">    method_list_t *baseMethods() const &#123;</div><div class="line">        return baseMethodList;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef struct objc_selector *SEL;</div><div class="line">typedef id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...);</div></pre></td></tr></table></figure>
<p><strong>id</strong>æŒ‡ä»£objcä¸­çš„å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡çš„åœ¨å†…å­˜çš„ç»“æ„å¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œä½†å…¶é¦–åœ°å€æŒ‡å‘çš„è‚¯å®šæ˜¯isaã€‚é€šè¿‡isaæŒ‡é’ˆï¼Œè¿è¡Œæ—¶å°±èƒ½è·å–åˆ°objc_classã€‚</p>
<p><strong>objc_class</strong>è¡¨ç¤ºå¯¹è±¡çš„Classï¼Œå®ƒçš„ç»“æ„æ˜¯ç¡®å®šçš„ï¼Œç”±ç¼–è¯‘å™¨ç”Ÿæˆã€‚</p>
<p><strong>SEL</strong>è¡¨ç¤ºé€‰æ‹©å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é€æ˜ç»“æ„ä½“ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œé€šå¸¸å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä¾‹å¦‚printf(â€œ%sâ€,@selector(isEqual:))ä¼šæ‰“å°å‡ºâ€isEqual:â€ã€‚è¿è¡Œæ—¶ç»´æŠ¤ç€ä¸€å¼ SELçš„è¡¨ï¼Œå°†ç›¸åŒå­—ç¬¦ä¸²çš„æ–¹æ³•åæ˜ å°„åˆ°å”¯ä¸€ä¸€ä¸ªSELã€‚  é€šè¿‡sel_registerName(char *name)æ–¹æ³•ï¼Œå¯ä»¥æŸ¥æ‰¾åˆ°è¿™å¼ è¡¨ä¸­æ–¹æ³•åå¯¹åº”çš„SELã€‚è‹¹æœæä¾›äº†ä¸€ä¸ªè¯­æ³•ç³–@selectorç”¨æ¥æ–¹ä¾¿åœ°è°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<p><strong>IMP</strong>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚objcä¸­çš„æ–¹æ³•æœ€ç»ˆä¼šè¢«è½¬æ¢æˆçº¯Cçš„å‡½æ•°ï¼ŒIMPå°±æ˜¯ä¸ºäº†è¡¨ç¤ºè¿™äº›å‡½æ•°çš„åœ°å€ã€‚</p>
<p>é‚£ä¹ˆobjc_msgSendç©¶ç«Ÿåšäº†ä»€ä¹ˆå‘¢? è¿™ä¸ªæ–¹æ³•æ˜¯ç”±æ±‡ç¼–å®ç°å¾—, ç”¨ä¼ªä»£ç å¤§æ¦‚å¯ä»¥è¡¨ç¤ºä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">id objc_msgSend(id self, SEL op, ...) &#123;</div><div class="line">    if (!self) return nil;</div><div class="line">	IMP imp = class_getMethodImplementation(self-&gt;isa, SEL op);</div><div class="line">	imp(self, op, ...); //è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¼ªä»£ç ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦å¤–åœ¨objc-msg-arm64.s ä¸­æ‰¾åˆ°å¦‚ä¸‹å…³é”®ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.macro MethodTableLookup</div><div class="line">	...</div><div class="line">	bl	__class_lookupMethodAndLoadCache3</div></pre></td></tr></table></figure>
<p>ä»¥åŠobjc-runtime-new.mm :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls)</div><div class="line">&#123;</div><div class="line">    return lookUpImpOrForward(cls, sel, obj, </div><div class="line">                              YES/*initialize*/, NO/*cache*/, YES/*resolver*/);</div><div class="line">&#125;</div><div class="line"></div><div class="line">IMP lookUpImpOrForward(Class cls, SEL sel, id inst, </div><div class="line">                       bool initialize, bool cache, bool resolver)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    </div><div class="line">    // Try this class&apos;s cache.</div><div class="line"></div><div class="line">    imp = cache_getImp(cls, sel);</div><div class="line">    if (imp) goto done;</div><div class="line"></div><div class="line">    // Try this class&apos;s method lists.</div><div class="line">    &#123;</div><div class="line">        Method meth = getMethodNoSuper_nolock(cls, sel);</div><div class="line">        if (meth) &#123;</div><div class="line">            log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls);</div><div class="line">            imp = meth-&gt;imp;</div><div class="line">            goto done;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Try superclass caches and method lists.</div><div class="line">    &#123;</div><div class="line">        unsigned attempts = unreasonableClassCount();</div><div class="line">        for (Class curClass = cls-&gt;superclass;</div><div class="line">             curClass != nil;</div><div class="line">             curClass = curClass-&gt;superclass)</div><div class="line">        &#123;</div><div class="line">            // Halt if there is a cycle in the superclass chain.</div><div class="line">            if (--attempts == 0) &#123;</div><div class="line">                _objc_fatal(&quot;Memory corruption in class list.&quot;);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Superclass cache.</div><div class="line">            imp = cache_getImp(curClass, sel);</div><div class="line">            if (imp) &#123;</div><div class="line">                if (imp != (IMP)_objc_msgForward_impcache) &#123;</div><div class="line">                    // Found the method in a superclass. Cache it in this class.</div><div class="line">                    log_and_fill_cache(cls, imp, sel, inst, curClass);</div><div class="line">                    goto done;</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    // Found a forward:: entry in a superclass.</div><div class="line">                    // Stop searching, but don&apos;t cache yet; call method </div><div class="line">                    // resolver for this class first.</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Superclass method list.</div><div class="line">            Method meth = getMethodNoSuper_nolock(curClass, sel);</div><div class="line">            if (meth) &#123;</div><div class="line">                log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass);</div><div class="line">                imp = meth-&gt;imp;</div><div class="line">                goto done;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // No implementation found. Try method resolver once.</div><div class="line"></div><div class="line">    if (resolver  &amp;&amp;  !triedResolver) &#123;</div><div class="line">        runtimeLock.unlockRead();</div><div class="line">        _class_resolveMethod(cls, sel, inst);</div><div class="line">        runtimeLock.read();</div><div class="line">        // Don&apos;t cache the result; we don&apos;t hold the lock so it may have </div><div class="line">        // changed already. Re-do the search from scratch instead.</div><div class="line">        triedResolver = YES;</div><div class="line">        goto retry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // No implementation found, and method resolver didn&apos;t help. </div><div class="line">    // Use forwarding.</div><div class="line"></div><div class="line">    imp = (IMP)_objc_msgForward_impcache;</div><div class="line">    cache_fill(cls, sel, imp, inst);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥<code>[cat mew];</code>ä¸ºä¾‹, æ€»ç»“ä¸€ä¸‹å°±æ˜¯:</p>
<ol>
<li>é€šè¿‡catçš„isaæŒ‡é’ˆæ‰¾åˆ°å®ƒçš„class, ä¹Ÿå°±æ˜¯Catç±»</li>
<li>åœ¨Catçš„cacheåˆ—è¡¨ä¸­æŸ¥æ‰¾mew</li>
<li>åœ¨Catçš„methodåˆ—è¡¨ä¸­æŸ¥æ‰¾mew</li>
<li>åœ¨çˆ¶ç±»çš„cacheå’Œmethodåˆ—è¡¨ä¸­æŸ¥æ‰¾mew</li>
<li>åœ¨2-4çš„è¿‡ç¨‹ä¸­, ä¸€æ—¦æ‰¾åˆ°å°±å°†è¯¥æ–¹æ³•æ·»åŠ åˆ°ç¼“å­˜åˆ—è¡¨å¹¶æ‰§è¡Œè¯¥æ–¹æ³•</li>
<li>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•çš„æ–¹æ³•å®ç°, Try method resolver once, ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„resolveInstanceMethodæ–¹æ³•</li>
<li>resolveInstanceMethodæ²¡å®ç°, å°±è¿›å…¥è½¬å‘æœºåˆ¶</li>
</ol>
<p><strong>å¦éœ€æ³¨æ„</strong>: å¦‚æœæ˜¯ç±»æ–¹æ³•çš„è°ƒç”¨, åˆ™æ˜¯å»Catçš„å…ƒç±»ä¸­æŸ¥æ‰¾, å› ä¸ºç±»æ–¹æ³•éƒ½æ˜¯ä¿å­˜åœ¨meta classä¸­, ä¾æ¬¡å‘çˆ¶å…ƒç±»æŸ¥æ‰¾, æ³¨æ„, åˆ°NSObject meta class, å®ƒçš„çˆ¶ç±»æ˜¯NSObjectæœ¬ç±», å¦‚æœè¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ªåŒåçš„å®ä¾‹æ–¹æ³•, ä¹Ÿå¯ä»¥è°ƒç”¨. ä¾‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@interface NSObject (Sark)</div><div class="line">+ (void)foo;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation NSObject (Sark)</div><div class="line">- (void)foo &#123;</div><div class="line">    NSLog(@&quot;IMP: - [NSObject (sark) foo]&quot;);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">[NSObject foo]; // æ‰“å° IMP: - [NSObject (sark) foo]</div></pre></td></tr></table></figure>
<h2 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h2><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ¥éªŒè¯ä¸€ä¸‹, è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•, åœ¨è¿è¡Œæ—¶å‘äº†å“ªäº›æ¶ˆæ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Cat *cat = Cat.new;</div><div class="line">[cat performSelector:@selector(lalala)];</div></pre></td></tr></table></figure>
<p>å…·ä½“æ–¹æ³•å¦‚ä¸‹:</p>
<ol>
<li>æ–­ç‚¹æš‚åœåæ‰§è¡Œ<code>call (void)instrumentObjcMessageSends(YES)</code><p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/instrumentObjcMessageSends.png"></p></li>
<li>ç„¶åè¿‡æ‰æ–­ç‚¹, ç¨‹åºå´©æºƒ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">2018-03-01 17:37:05.671634+0800 msg_send[18226:862391] -[Cat lalala]: unrecognized selector sent to instance 0x10054d9e0</div><div class="line">2018-03-01 17:37:05.676829+0800 msg_send[18226:862391] *** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;-[Cat lalala]: unrecognized selector sent to instance 0x10054d9e0&apos;</div><div class="line">*** First throw call stack:</div><div class="line">(</div><div class="line">	0   CoreFoundation                      0x00007fff4eabc54b __exceptionPreprocess + 171</div><div class="line">	1   libobjc.A.dylib                     0x00007fff7658bc76 objc_exception_throw + 48</div><div class="line">	2   CoreFoundation                      0x00007fff4eb55024 -[NSObject(NSObject) doesNotRecognizeSelector:] + 132</div><div class="line">	3   CoreFoundation                      0x00007fff4ea32a90 ___forwarding___ + 1456</div><div class="line">	4   CoreFoundation                      0x00007fff4ea32458 _CF_forwarding_prep_0 + 120</div><div class="line">	5   msg_send                            0x0000000100001c76 main + 86</div><div class="line">	6   libdyld.dylib                       0x00007fff771a5015 start + 1</div><div class="line">)</div><div class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</div></pre></td></tr></table></figure>
<p>3.åœ¨Terminalä¸­è¾“å…¥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">open /private/tmp</div></pre></td></tr></table></figure>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/instrumentObjcMessageSends_path.png"></p><br>4.æ‰“å¼€æŸ¥çœ‹<br><p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/instrumentObjcMessageSends_result.png"></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- Cat NSObject performSelector:</div><div class="line">+ Cat NSObject resolveInstanceMethod:</div><div class="line">+ Cat NSObject resolveInstanceMethod:</div><div class="line">- Cat NSObject forwardingTargetForSelector:</div><div class="line">- Cat NSObject forwardingTargetForSelector:</div><div class="line">- Cat NSObject methodSignatureForSelector:</div><div class="line">- Cat NSObject methodSignatureForSelector:</div><div class="line">- Cat NSObject class</div><div class="line">- Cat NSObject doesNotRecognizeSelector:</div><div class="line">- Cat NSObject doesNotRecognizeSelector:</div><div class="line">- Cat NSObject class</div></pre></td></tr></table></figure>
<p>ç»“åˆ <a href="https://developer.apple.com/documentation/objectivec/nsobject?language=objc" target="_blank" rel="external">NSObjectå®˜æ–¹æ–‡æ¡£</a>, è½¬å‘æœºåˆ¶å¯å¦‚å›¾è¡¨ç¤º:</p>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/message_forward.png"></p>

<p>1.è°ƒç”¨resolveInstanceMethod:æ–¹æ³•ï¼Œå…è®¸ç”¨æˆ·åœ¨æ­¤æ—¶ä¸ºè¯¥ClassåŠ¨æ€æ·»åŠ å®ç°ã€‚å¦‚æœæœ‰å®ç°äº†ï¼Œåˆ™è°ƒç”¨å¹¶è¿”å›ã€‚å¦‚æœä»æ²¡å®ç°ï¼Œç»§ç»­ä¸‹é¢çš„åŠ¨ä½œã€‚</p>
<p>2.è°ƒç”¨forwardingTargetForSelector:æ–¹æ³•ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªèƒ½å“åº”è¯¥æ¶ˆæ¯çš„å¯¹è±¡ã€‚å¦‚æœè·å–åˆ°ï¼Œåˆ™ç›´æ¥è½¬å‘ç»™å®ƒã€‚å¦‚æœè¿”å›äº†nilï¼Œç»§ç»­ä¸‹é¢çš„åŠ¨ä½œã€‚</p>
<p>3.è°ƒç”¨methodSignatureForSelector:æ–¹æ³•ï¼Œå°è¯•è·å¾—ä¸€ä¸ªæ–¹æ³•ç­¾åã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ç›´æ¥è°ƒç”¨doesNotRecognizeSelectoræŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>4.è°ƒç”¨forwardInvocation:æ–¹æ³•ï¼Œå°†åœ°3æ­¥è·å–åˆ°çš„æ–¹æ³•ç­¾ååŒ…è£…æˆInvocationä¼ å…¥ï¼Œå¦‚ä½•å¤„ç†å°±åœ¨è¿™é‡Œé¢äº†ã€‚</p>
<p>ä¸Šé¢è¿™4ä¸ªæ–¹æ³•å‡æ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥overrideï¼Œç”±runtimeæ¥è°ƒç”¨ã€‚æœ€å¸¸è§çš„å®ç°æ¶ˆæ¯è½¬å‘ï¼Œå°±æ˜¯é‡å†™æ–¹æ³•3å’Œ4ï¼Œåæ‰ä¸€ä¸ªæ¶ˆæ¯æˆ–è€…ä»£ç†ç»™å…¶ä»–å¯¹è±¡éƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>: æˆ‘ä»¬ä¸ºDogç±»æ·»åŠ nameå±æ€§å’Œå®ä¾‹, ä½†é€šè¿‡@dynamicä½¿å…¶ä¸è‡ªåŠ¨ç”Ÿæˆsetterå’Œgetter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@interface Dog : NSObject</div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Dog &#123;</div><div class="line">    NSString *_name;</div><div class="line">&#125;</div><div class="line">@dynamic name;</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog = [Dog new];</div><div class="line">        dog.name = @&quot;Kiki&quot;;</div><div class="line">        NSLog(@&quot;%@&quot;, dog.name);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶dogå¯¹è±¡æ²¡æœ‰setName: æ–¹æ³•, ä¼šå°è¯•è§£å†³, æˆ‘ä»¬æ¥å®ç°resolveInstanceMethod æ–¹æ³•, å¹¶ä¸ºnameæ·»åŠ setter å’Œ getter (ä»–ä»¬çš„å†…éƒ¨å®ç°å¯ä»¥ç”¨æŒ‡é’ˆæŒ‡å‘, ä¹Ÿå¯ä»¥ç”¨è¿è¡Œæ—¶api)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">@implementation Dog &#123;</div><div class="line">    NSString *_name;</div><div class="line">&#125;</div><div class="line">@dynamic name;</div><div class="line">void mySetName(id self, SEL _cmd, NSString *newValue) &#123;</div><div class="line">//    Ivar ivar = class_getInstanceVariable(Dog.class, &quot;_name&quot;);</div><div class="line">//    object_setIvar(self, ivar, [newValue copy]);</div><div class="line">    if (((Dog *)self)-&gt;_name != newValue) &#123;</div><div class="line">        ((Dog *)self)-&gt;_name = [newValue copy];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">NSString * myGetName(id self, SEL _cmd) &#123;</div><div class="line">//    Ivar ivar = class_getInstanceVariable(Dog.class, &quot;_name&quot;);</div><div class="line">//    return object_getIvar(self, ivar);</div><div class="line">    return ((Dog *)self)-&gt;_name;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</div><div class="line">    NSLog(@&quot;%s&quot;, __func__);</div><div class="line">    if ([NSStringFromSelector(sel) isEqualToString:@&quot;setName:&quot;]) &#123;</div><div class="line">        class_addMethod(self, sel, (IMP)mySetName, &quot;v@:@&quot;);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        class_addMethod(self, sel, (IMP)myGetName, &quot;@@:&quot;);</div><div class="line">    &#125;</div><div class="line">    return YES;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>å¦‚æœä¸å®ç°ä¸Šè¿°æ–¹æ³•, ä¹Ÿå¯ä»¥è½¬å‘ç»™åˆ«çš„å¯¹è±¡:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@implementation Dog &#123;</div><div class="line">    NSString *_name;</div><div class="line">&#125;</div><div class="line">@dynamic name;</div><div class="line"></div><div class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</div><div class="line">    NSLog(@&quot;%s&quot;, __func__);</div><div class="line">    return Cat.new;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>è¯¥æ¶ˆæ¯è½¬å‘ç»™Catç±»çš„ä¸€ä¸ªå¯¹è±¡, å»è°ƒç”¨Catçš„setName:æ–¹æ³•, å½“ç„¶è¿™æ²¡ä»€ä¹ˆå®é™…çš„æ„ä¹‰.</p>
<p>ç¬¬ä¸‰æ¬¡è¡¥æ•‘:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">@implementation Dog &#123;</div><div class="line">    NSString *_name;</div><div class="line">&#125;</div><div class="line">@dynamic name;</div><div class="line"></div><div class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    NSLog(@&quot;%s&quot;, __func__);</div><div class="line">    NSString *selStr = NSStringFromSelector(aSelector);</div><div class="line">    if([selStr isEqualToString:@&quot;name&quot;]) &#123;</div><div class="line">        NSMethodSignature *sig = [NSMethodSignature signatureWithObjCTypes:&quot;@@:&quot;];</div><div class="line">        return sig;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        NSMethodSignature *sig = [NSMethodSignature signatureWithObjCTypes:&quot;v@:@&quot;];</div><div class="line">        return sig;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</div><div class="line">    NSLog(@&quot;%s&quot;, __func__);</div><div class="line">    </div><div class="line">    SEL sel = [anInvocation selector];</div><div class="line">    Cat *cat = [[Cat alloc] init];</div><div class="line">    if([cat respondsToSelector:sel]) &#123;</div><div class="line">        [anInvocation invokeWithTarget:cat];</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        [self doesNotRecognizeSelector:sel];</div><div class="line">    &#125; </div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>é¦–å…ˆç”Ÿæˆæ–¹æ³•ç­¾å, ç„¶åè½¬å‘è°ƒç”¨, å¦‚æœæ²¡æœ‰å®ç°forward, é‚£ç›´æ¥è°ƒç”¨doesNotRecognizeSelector, æŠ›å‡ºexception, ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨doesNotRecognizeSelector, è¿™æ ·å°±åæ²¡äº†è¿™ä¸ªæ¶ˆæ¯.</p>
<p>__åŸåˆ›æ–‡ç« , è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/02/02/atexit-Pythonç¨‹åºç»“æŸæ—¶çš„å›è°ƒ/">atexit - pythonç¨‹åºç»“æŸæ—¶çš„å›è°ƒ</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Feb 2, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>ç”¨pythonå†™ä¸€äº›apiæµ‹è¯•, éœ€è¦åœ¨ç¨‹åºç»“æŸå‰è®°å½•æ—¶é—´, å°è¯•äº†å„ç§ä¸­æ–‡çš„è‹±æ–‡çš„å…³é”®è¯, ç»ˆäºæœç´¢åˆ°atexitè¿™ä¸ªæ¨¡å—.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> atexit</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_function</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"exiting"</span>)</div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_function2</span><span class="params">(name, age)</span>:</span></div><div class="line">    print(<span class="string">"exiting2: "</span> + name + <span class="string">" "</span> + str(age))</div><div class="line">	</div><div class="line"><span class="meta">@atexit.register</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_function3</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"exiting3"</span>)</div><div class="line">	</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    atexit.register(exit_function)</div><div class="line">    atexit.register(exit_function2, <span class="string">'Phoenix'</span>, <span class="number">22</span>)</div></pre></td></tr></table></figure>
<p>å¯æ³¨å†Œå¤šä¸ªå›è°ƒå‡½æ•°, ä¹Ÿå¯ä»¥ä¼ å…¥å‚æ•°, ä¹Ÿå¯ä»¥ä½¿ç”¨è£…é¥°å™¨æ¥ä¿®é¥°éœ€è¦å›è°ƒçš„å‡½æ•°, æ‰§è¡Œé¡ºåºæ˜¯<strong>å…ˆè¿›åå‡º</strong>, ä»£ç ç”±ä¸Šè‡³ä¸‹, æ‰€ä»¥æ³¨å†Œé¡ºåºæ˜¯exit_function3, exit_function, exit_function2, æ‰€ä»¥æ‰§è¡Œé¡ºåºåè¿‡æ¥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">exiting2: 22Phoenix</div><div class="line">exiting</div><div class="line">exiting3</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„</strong>: å¦‚æœç¨‹åºæ˜¯éæ­£å¸¸crashï¼Œæˆ–é€šè¿‡os._exit()é€€å‡ºï¼Œæ³¨å†Œçš„å›è°ƒå‡½æ•°å°†ä¸ä¼šè¢«è°ƒç”¨.</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/01/12/Python-Fabric-è‡ªåŠ¨åŒ–éƒ¨ç½²/">Python Fabric è‡ªåŠ¨åŒ–éƒ¨ç½²</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jan 12, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>æœ€è¿‘å…¬å¸åœ¨åšåœ¨çº¿æŠ“å¨ƒå¨ƒ, é¢†å¯¼è®©æˆ‘å†™ä¸ªè¿ç»´è„šæœ¬ä¸€é”®éƒ¨ç½²ä»£ç åˆ°æ‰€æœ‰å¨ƒå¨ƒæœº, è¦æ±‚æ—¶é—´æ˜¯ä¸€å¤©ä¹‹å†…æå®š, å¾ˆå¥½, æ„Ÿè°¢æ‚¨çš„ä¿¡ä»», è®©ä¸€ä¸ªpythoné›¶åŸºç¡€çš„äººåšè¿™ä¸ª, æˆ‘çš„å†…å¿ƒæ˜¯å´©æºƒçš„â€¦.åªèƒ½å…ˆæ‰¾ä¸ªpythonåŸºç¡€çš„å¸–å­è¿‡ä¸€é, ç„¶åå¼€å§‹æ„£å†™. ç°åœ¨ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« åˆ†äº«å‘¢, å› ä¸ºæˆ‘çœŸçš„ä¸€å¤©ä¹‹å†…å†™å‡ºæ¥äº†, çœ‹æ¥äººçœŸçš„æ˜¯é€¼å‡ºæ¥çš„.</p>
<p>äº†è§£åˆ°fabricæ¡†æ¶å¯ä»¥å®ç°å¤šå°è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½², è€Œæˆ‘ä»¬å¨ƒå¨ƒæœºç”¨çš„æ˜¯æ ‘è“æ´¾å®‰è£…çš„Ubuntu, åŒæ ·éƒ½æ˜¯linuxæ‰€ä»¥é€‚ç”¨</p>
<h2 id="å®‰è£…fabric"><a href="#å®‰è£…fabric" class="headerlink" title="å®‰è£…fabric"></a>å®‰è£…fabric</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install fabric</div></pre></td></tr></table></figure>
<h2 id="åˆ›å»ºfabricè„šæœ¬"><a href="#åˆ›å»ºfabricè„šæœ¬" class="headerlink" title="åˆ›å»ºfabricè„šæœ¬"></a>åˆ›å»ºfabricè„šæœ¬</h2><p>æ–°å»ºåä¸ºfabfile.pyçš„æ–‡ä»¶, æ·»åŠ ä»£ç :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"hello world"</span>)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ fab hello</div><div class="line">hello world</div></pre></td></tr></table></figure>
<p>fabfile.py æ˜¯fabricé»˜è®¤è¯†åˆ«çš„æ–‡ä»¶å, ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«çš„æ–‡ä»¶å, ä½†ä½¿ç”¨æ—¶åŠ å‚æ•°, å¦‚:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ fab -f test.py hello</div><div class="line">hello world</div></pre></td></tr></table></figure>
<h2 id="ä¸»è¦ä»£ç "><a href="#ä¸»è¦ä»£ç " class="headerlink" title="ä¸»è¦ä»£ç "></a>ä¸»è¦ä»£ç </h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append</div><div class="line"></div><div class="line">env.hosts = [<span class="string">'192.168.0.1'</span>, <span class="string">'192.168.0.2:20001'</span>] <span class="comment"># åœ°å€åˆ—è¡¨</span></div><div class="line">env.password = <span class="string">'I am the password of the remote server'</span></div><div class="line">env.user = <span class="string">'root'</span></div><div class="line">env.colorize_errors = <span class="keyword">True</span> <span class="comment"># å‡ºé”™æ—¶ä»¥çº¢è‰²æ˜¾ç¤ºæ—¥å¿—</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">fabric ä¸­lcdè¡¨ç¤ºåœ¨æœ¬åœ°æœåŠ¡å™¨æ‰§è¡Œcd, localè¡¨ç¤ºåœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤</div><div class="line">@runs_once è¡¨ç¤ºä¸ç®¡æœ‰å¤šå°‘ä¸ªhost, @runs_onceä¿®é¥°çš„æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡</div><div class="line">æ­¤æ–¹æ³•å°±æ˜¯æ‹‰ä»£ç , ä½†è¦é…ç½®ssh key, å¦åˆ™æ‰‹åŠ¨è¾“gitè´¦æˆ·å¯†ç æ€ä¹ˆèƒ½å«ä¸€é”®éƒ¨ç½²å‘¢</div><div class="line">'''</div><div class="line"><span class="meta">@runs_once</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">with</span> lcd(<span class="string">'/home/yunai/wawaji/device/'</span>):</div><div class="line">         local(<span class="string">'git pull'</span>)</div><div class="line">         </div><div class="line"><span class="string">'''</span></div><div class="line">@parallel ä¿®é¥°çš„æ–¹æ³•å°±æ˜¯åœ¨æ¯å°æœºå™¨ä¸Šéƒ½æ‰§è¡Œçš„æ–¹æ³•</div><div class="line">pool_size è¡¨ç¤ºæœ€å¤§å¹¶å‘æ•°é‡</div><div class="line">'''</div><div class="line"><span class="meta">@parallel(pool_size=10)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># è¾“å‡ºç­‰çº§è®¾ç½®ï¼Œéšè—æŒ‡å®šçš„ç±»å‹</span></div><div class="line">    <span class="keyword">with</span> settings(</div><div class="line">        hide(<span class="string">'warnings'</span>, <span class="string">'running'</span>, <span class="string">'stdout'</span>, <span class="string">'stderr'</span>),</div><div class="line">        warn_only=<span class="keyword">True</span></div><div class="line">    ):</div><div class="line">        <span class="comment"># å®é™…ä¸šåŠ¡, æˆ‘ä»¬æ˜¯ä»¥æŸä¸ªæ–‡ä»¶çš„æŸè¡Œå†…å®¹æ¥ä½œä¸ºæ˜¯å¦æ›´æ–°è¿‡çš„æ ‡å‡†, è¿™ä¸ªå°±æ ¹æ®å®é™…éœ€æ±‚æ¥åˆ¶å®šå°±å¥½</span></div><div class="line">        <span class="keyword">if</span> sudo(<span class="string">'grep internal /home/yunai/wawaji/control/control.py'</span>):</div><div class="line">            <span class="comment"># env.host_string è¡¨ç¤ºå½“å‰æ­£åœ¨æ›´æ–°çš„æœºå™¨çš„host</span></div><div class="line">            <span class="keyword">print</span> env.host_string + <span class="string">' had been updated before, canceled.'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> env.host_string + <span class="string">' updating file...'</span></div><div class="line">            <span class="comment"># ä»¥sudoæ›´æ–°ä¸€ä¸ªæ–‡ä»¶</span></div><div class="line">            put(local_path=<span class="string">'/home/yunai/wawaji/device/control/control.py'</span>, remote_path=<span class="string">'/home/yunai/wawaji/control/'</span>, use_sudo=<span class="keyword">True</span>, mode=<span class="number">755</span>)</div><div class="line">            <span class="comment"># ä»¥sudoç»™æ–‡ä»¶è¿½åŠ å†…å®¹, ç›¸å½“äº:</span></div><div class="line">            <span class="comment"># sudo('echo "NTP=192.168.0.3 192.168.0.2" &gt;&gt; /etc/systemd/timesyncd.conf')</span></div><div class="line">            <span class="comment"># ä½†fabricçš„appendä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶æœ«æ˜¯å¦å·²æœ‰è¯¥å†…å®¹, å¦‚æœæœ‰, åˆ™ä¸å†è¿½åŠ </span></div><div class="line">            append(<span class="string">'/etc/systemd/timesyncd.conf'</span>, <span class="string">'NTP=192.168.0.3 192.168.0.2'</span>, use_sudo=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">print</span> env.host_string + <span class="string">' update completed'</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">åœ¨å¤–éƒ¨è®¾ç½®ipçš„æ–¹æ³•</div><div class="line">ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨è¯¥æ–¹æ³•, åœ¨å†…éƒ¨ç›´æ¥å†™å¥½æ‰€æœ‰ip</div><div class="line">'''      </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_ips</span><span class="params">(*ips)</span>:</span></div><div class="line">    [env.hosts.append(p) <span class="keyword">for</span> p <span class="keyword">in</span> ips <span class="keyword">if</span> p <span class="keyword">not</span> <span class="keyword">in</span> env.hosts]</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ fab set_ips:&apos;192.168.0.3&apos;,&apos;192.168.0.22&apos; prepare update</div></pre></td></tr></table></figure>
<h2 id="ä»æ•°æ®åº“è·å–ip"><a href="#ä»æ•°æ®åº“è·å–ip" class="headerlink" title="ä»æ•°æ®åº“è·å–ip"></a>ä»æ•°æ®åº“è·å–ip</h2><p>åˆæœŸé¢†å¯¼ç»™æˆ‘çš„ipåˆ—è¡¨éƒ½æ˜¯æˆªå›¾, æˆ‘çš„å†…å¿ƒé‚£æ˜¯ç›¸å½“å´©æºƒçš„, éš¾é“æ‰‹æ‰“å‡ºæ¥å—, å½“ç„¶ä¸æ˜¯, æœºæ™ºçš„æˆ‘æ‰¾äº†ä¸ªå›¾ç‰‡è¯†åˆ«ç½‘ç«™å…ˆè½¬æˆæ–‡æœ¬, å†ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰ip.  åæœŸæ­¥å…¥æ­£è½¨ç”¨æ•°æ®åº“å°±å¥½äº†, ä¸‹é¢æ¥è¯´pythonæ€ä¹ˆä½¿ç”¨<strong>pymysql</strong>æ¨¡å—æ¥æ“ä½œæ•°æ®åº“</p>
<p>å®‰è£…pymysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install pymysql</div></pre></td></tr></table></figure>
<p>æ“ä½œæ•°æ®åº“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pymysql</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">all_ip</span><span class="params">()</span>:</span></div><div class="line">    connection = pymysql.connect(</div><div class="line">        host = <span class="string">"127.0.0.1"</span>,</div><div class="line">        user = <span class="string">"root"</span>,</div><div class="line">        password = <span class="string">"I am the password of mysql"</span>,</div><div class="line">        database = <span class="string">"doll"</span>, <span class="comment"># æ•°æ®åº“å</span></div><div class="line">        charset = <span class="string">'utf8'</span></div><div class="line">        <span class="comment"># æˆ‘ä»¬å¯ä»¥åœ¨æ­¤å¤„æ¥é…ç½®è¿”å›ç±»å‹, å¦‚ä¸‹å°†æŒ‰å­—å…¸è¿”å›, ä¸å®šä¹‰åˆ™è¿”å›tuple</span></div><div class="line">        <span class="comment"># cursorclass = pymysql.cursors.DictCursor</span></div><div class="line">        <span class="comment"># æ–‡æ¡£é“¾æ¥: http://mysql-python.sourceforge.net/MySQLdb-1.2.2/public/MySQLdb.cursors-module.html</span></div><div class="line">    )</div><div class="line"></div><div class="line">    cursor = connection.cursor()</div><div class="line">    result = cursor.execute(<span class="string">"select ipaddress from device;"</span>) <span class="comment"># æŸ¥è¡¨</span></div><div class="line"></div><div class="line">    result = cursor.fetchall()</div><div class="line">    cursor.close()</div><div class="line">    connection.close()</div><div class="line">    </div><div class="line">    <span class="comment"># æ­¤æ—¶resultç»“æœåº”ä¸º(('192.168.0.1',), ('192.168.0.33',),)</span></div><div class="line">    new_array = []</div><div class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> map(<span class="keyword">lambda</span> x: x, result):</div><div class="line">        <span class="keyword">for</span> ip <span class="keyword">in</span> t:</div><div class="line">            new_array.append(ip)</div><div class="line">    <span class="comment"># å°†ipæ•°ç»„è½¬æ¢ä¸ºæ–¹æ³•å‚æ•°æ ¼å¼</span></div><div class="line">    ipset = set(new_array)</div><div class="line">    <span class="comment"># å†…éƒ¨è®¾ç½®ipåˆ—è¡¨</span></div><div class="line">    set_ips(*ipset)</div></pre></td></tr></table></figure>
<p>æœ€åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿™æ ·æ¥è°ƒç”¨äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ fab all_ip update</div></pre></td></tr></table></figure>
<p>é™„ä¸ŠFabricæ–‡æ¡£é“¾æ¥ <a href="http://docs.fabfile.org/en/1.14/" target="_blank" rel="external">http://docs.fabfile.org/en/1.14/</a> éœ€è¦ä»€ä¹ˆæŸ¥æ–‡æ¡£å°±å¥½äº†!!</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/01/11/Hexo-ä½¿ç”¨æ•™ç¨‹/">Hexo ä½¿ç”¨æ•™ç¨‹</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jan 11, 2018
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>å¤ªä¹…æ²¡å†™åšå®¢éƒ½å¿˜äº†å’‹ç”¨äº†, è¿˜å¾—ç°å»æŸ¥, è¿˜æ˜¯è‡ªå·±æ¥è®°å½•ä¸‹ä¸€ä¸‹å§, æ¯•ç«Ÿå†ç®€å•çš„ä¸œè¥¿ä¹Ÿç¦ä¸ä½å¿˜å•Šâ€¦</p>
<h2 id="è¿›å…¥ç›®å½•â€¦"><a href="#è¿›å…¥ç›®å½•â€¦" class="headerlink" title="è¿›å…¥ç›®å½•â€¦"></a>è¿›å…¥ç›®å½•â€¦</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd ~/asura19.github.io</div></pre></td></tr></table></figure>
<h2 id="æ–°å»ºæ–‡ç« "><a href="#æ–°å»ºæ–‡ç« " class="headerlink" title="æ–°å»ºæ–‡ç« "></a>æ–°å»ºæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new &quot;ä¸€ä¸ªæ ‡é¢˜&quot;</div></pre></td></tr></table></figure>
<h2 id="æ‰“å¼€æ–‡ç« "><a href="#æ‰“å¼€æ–‡ç« " class="headerlink" title="æ‰“å¼€æ–‡ç« "></a>æ‰“å¼€æ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">åœ¨è·¯å¾„ ~/asura19.github.io/source/_posts/ ä¸‹æ‰“å¼€ç›¸åº”æ–‡ç« </div></pre></td></tr></table></figure>
<h2 id="ç”¨Markdownå†™æ–‡ç« "><a href="#ç”¨Markdownå†™æ–‡ç« " class="headerlink" title="ç”¨Markdownå†™æ–‡ç« "></a>ç”¨Markdownå†™æ–‡ç« </h2><p>â€œblablablaâ€¦â€</p>
<h2 id="ç”Ÿæˆé™æ€æ–‡ä»¶"><a href="#ç”Ÿæˆé™æ€æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆé™æ€æ–‡ä»¶"></a>ç”Ÿæˆé™æ€æ–‡ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo generate  (å¯ç®€å†™ä¸º hexo g)</div></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æŸ¥çœ‹"><a href="#å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æŸ¥çœ‹" class="headerlink" title="å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æŸ¥çœ‹"></a>å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æŸ¥çœ‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo server  (å¯ç®€å†™ä¸º hexo s)</div></pre></td></tr></table></figure>
<h2 id="éƒ¨ç½²åˆ°ç½‘ç«™"><a href="#éƒ¨ç½²åˆ°ç½‘ç«™" class="headerlink" title="éƒ¨ç½²åˆ°ç½‘ç«™"></a>éƒ¨ç½²åˆ°ç½‘ç«™</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo deploy  (å¯ç®€å†™ä¸º hexo d)</div></pre></td></tr></table></figure>
<h2 id="é‡æ–°å¡«å†™è‡ªå®šä¹‰åŸŸå"><a href="#é‡æ–°å¡«å†™è‡ªå®šä¹‰åŸŸå" class="headerlink" title="é‡æ–°å¡«å†™è‡ªå®šä¹‰åŸŸå"></a>é‡æ–°å¡«å†™è‡ªå®šä¹‰åŸŸå</h2><p>å¦‚æœåœ¨githubé…ç½®äº†è‡ªå®šä¹‰åŸŸå, é‚£ä¹ˆhexo deployä¹‹åä¸çŸ¥ä¸ºä½•ä¼šå°†åŸŸåæ¶ˆæ‰, æ‰€ä»¥è¦åœ¨é¡¹ç›®Setting-Custom domainé‡æ–°å¡«å†™åŸŸå</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/17/Objective-C-runtime-å¸¸ç”¨apiåŠç¤ºä¾‹/">Objective-C runtime å¸¸ç”¨apiåŠç¤ºä¾‹</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Sep 17, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„è¿è¡Œæ—¶api. <a href="https://github.com/Asura19/RuntimeDemo" target="_blank" rel="external">æœ¬æ–‡Demo</a></p>
<h2 id="Demoç±»ä»£ç "><a href="#Demoç±»ä»£ç " class="headerlink" title="Demoç±»ä»£ç "></a>Demoç±»ä»£ç </h2><p>Cat.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@protocol Cute</div><div class="line">@optional</div><div class="line">- (void)isCute;</div><div class="line">@end</div><div class="line"></div><div class="line">@protocol Movable</div><div class="line">@optional</div><div class="line">- (void)run;</div><div class="line">@end</div><div class="line"></div><div class="line">@interface Cat : NSObject&lt;Movable&gt;</div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">- (void)mew;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>Cat.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">@implementation Cat &#123;</div><div class="line">    NSColor *_color;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (void)mews &#123;</div><div class="line">    NSLog(@&quot;+++++å–µ+++++&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)init &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (self) &#123;</div><div class="line">        _color = [NSColor blackColor];</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)mew &#123;</div><div class="line">    NSLog(@&quot;-----å–µ-----&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)run &#123;</div><div class="line">    NSLog(@&quot;~~run~~&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSArray *)method0:(NSArray *)agu0</div><div class="line">                agu1:(CGFloat)agu1</div><div class="line">                agu2:(NSObject *)agu2</div><div class="line">                agu3:(NSString *)agu3</div><div class="line">                agu4:(CGRect)agu4 &#123;</div><div class="line">    </div><div class="line">    NSLog(@&quot;test method&quot;);</div><div class="line">    return @[];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)method0 &#123;</div><div class="line">    NSLog(@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;0:%s&quot;, __func__);</div><div class="line">&#125;</div><div class="line">- (void)method1 &#123;</div><div class="line">    NSLog(@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;1:%s&quot;, __func__);</div><div class="line">&#125;</div><div class="line">- (void)method2 &#123;</div><div class="line">    NSLog(@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;2:%s&quot;, __func__);</div><div class="line">&#125;</div><div class="line">+ (void)catClassMethod &#123;</div><div class="line">    NSLog(@&quot;~~cat class method~~&quot;);</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>Cat+YYAdd.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@interface Cat (YYAdd)</div><div class="line">@property (nonatomic, assign) float weight;</div><div class="line">- (void)jump;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>Cat+YYAdd.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@implementation Cat (YYAdd)</div><div class="line"></div><div class="line">- (void)setWeight:(float)weight &#123;</div><div class="line">    objc_setAssociatedObject(self, @selector(weight), @(weight), OBJC_ASSOCIATION_ASSIGN);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (float)weight &#123;</div><div class="line">    return [objc_getAssociatedObject(self, _cmd) floatValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)jump &#123;</div><div class="line">    NSLog(@&quot;~~Cat jump~~&quot;);</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<h2 id="Runtime-Demo"><a href="#Runtime-Demo" class="headerlink" title="Runtime Demo"></a>Runtime Demo</h2><h3 id="classéƒ¨åˆ†"><a href="#classéƒ¨åˆ†" class="headerlink" title="classéƒ¨åˆ†"></a>classéƒ¨åˆ†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line">// è·å–ç±»å</div><div class="line">const char *className = class_getName(Cat.class);</div><div class="line">NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:className]);</div><div class="line">// ç»“æœ: Cat</div><div class="line"></div><div class="line">// è·å–çˆ¶ç±»</div><div class="line">Class superClass = class_getSuperclass(Cat.class);</div><div class="line">NSLog(@&quot;%@&quot;, superClass);</div><div class="line">// ç»“æœ: NSObject</div><div class="line"></div><div class="line">// è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯è·å–ç±»çš„å®ä¾‹æ‰€å ç”¨å†…å­˜çš„å¤§å°</div><div class="line">size_t instanceSizeOfClass = class_getInstanceSize(Cat.class);</div><div class="line">NSLog(@&quot;%zu&quot;, instanceSizeOfClass);</div><div class="line">// ç»“æœ: 24</div><div class="line"></div><div class="line">// è·å–å®ä¾‹å˜é‡</div><div class="line">Ivar ivar = class_getInstanceVariable(Cat.class, &quot;_color&quot;);</div><div class="line">NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:ivar_getName(ivar)]);</div><div class="line">// ç»“æœ: _color</div><div class="line">    </div><div class="line">// è·å–å±æ€§</div><div class="line">objc_property_t prop = class_getProperty(Cat.class, &quot;name&quot;);</div><div class="line">NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:property_getName(prop)]);</div><div class="line">// ç»“æœ: name</div><div class="line"></div><div class="line">// è·å–å®ä¾‹æ–¹æ³•çš„å®ç°, å¹¶æ‰§è¡Œ</div><div class="line">IMP mewImp = class_getMethodImplementation(Cat.class, @selector(mew));</div><div class="line">mewImp();</div><div class="line">// ç»“æœ: -----å–µ-----</div><div class="line"></div><div class="line">// è·å–ç±»çš„æ‰€æœ‰å®ä¾‹</div><div class="line">unsigned int ivarListCount = 0;</div><div class="line">Ivar *ivars = class_copyIvarList(Cat.class, &amp;ivarListCount);</div><div class="line">for (NSInteger i = 0; i &lt; ivarListCount; i++) &#123;</div><div class="line">   Ivar ivar = ivars[i];</div><div class="line">   const char *name = ivar_getName(ivar);</div><div class="line">   NSLog(@&quot;ivarList: %@&quot;, [NSString stringWithUTF8String:name]);</div><div class="line">&#125;</div><div class="line">free(ivars);</div><div class="line">// ç»“æœ: </div><div class="line">ivarList: _color</div><div class="line">ivarList: _name</div><div class="line"></div><div class="line">// è·å–ç±»çš„æ‰€æœ‰å±æ€§</div><div class="line">unsigned int propertyListCount = 0;</div><div class="line">objc_property_t *props = class_copyPropertyList(Cat.class, &amp;propertyListCount);</div><div class="line">for (NSInteger i = 0; i &lt; propertyListCount; i++) &#123;</div><div class="line">   objc_property_t property = props[i];</div><div class="line">   const char *name = property_getName(property);</div><div class="line">   NSLog(@&quot;propertyList: %@&quot;, [NSString stringWithUTF8String:name]);</div><div class="line">&#125;</div><div class="line">free(props);</div><div class="line">// ç»“æœ: </div><div class="line">propertyList: weight</div><div class="line">propertyList: name</div><div class="line">// ç”±æ­¤å¯è§, è¿è¡Œæ—¶æ·»åŠ çš„å…³è”å±æ€§, æ²¡æœ‰ç”Ÿæˆå®ä¾‹</div><div class="line"></div><div class="line">// è·å–ç±»çš„æ‰€æœ‰å®ä¾‹æ–¹æ³•</div><div class="line">unsigned int methodListCount = 0;</div><div class="line">Method *methods = class_copyMethodList(Cat.class, &amp;methodListCount);</div><div class="line">for (NSInteger i = 0; i &lt; methodListCount; i++) &#123;</div><div class="line">   Method method = methods[i];</div><div class="line">   SEL name = method_getName(method);</div><div class="line">   NSLog(@&quot;methodList: %@&quot;, NSStringFromSelector(name));</div><div class="line">&#125;</div><div class="line">free(methods);</div><div class="line">// ç»“æœ: </div><div class="line">methodList: mew</div><div class="line">methodList: method0:agu1:agu2:agu3:agu4:</div><div class="line">methodList: method0</div><div class="line">methodList: method1</div><div class="line">methodList: method2</div><div class="line">methodList: init</div><div class="line">methodList: .cxx_destruct</div><div class="line">methodList: name</div><div class="line">methodList: setName:</div><div class="line">methodList: run</div><div class="line">methodList: jump</div><div class="line">methodList: setWeight:</div><div class="line">methodList: weight</div><div class="line"></div><div class="line">// è·å–ç±»æ‰€éµå®ˆçš„åè®®</div><div class="line">unsigned int protocolListCount = 0;</div><div class="line">Protocol * __unsafe_unretained *protocols = class_copyProtocolList(Cat.class, &amp;protocolListCount);</div><div class="line">for (NSInteger i = 0; i &lt; protocolListCount; i++) &#123;</div><div class="line">   Protocol *protocal = protocols[i];</div><div class="line">   const char *name = protocol_getName(protocal);</div><div class="line">   NSLog(@&quot;protocolList: %@&quot;, [NSString stringWithUTF8String:name]);</div><div class="line">&#125;</div><div class="line">free(protocols);</div><div class="line">// ç»“æœ: protocolList: Movable</div><div class="line">    </div><div class="line">// è·å–ç±»çš„æŸä¸ªç±»æ–¹æ³•</div><div class="line">Method classMethod = class_getClassMethod(Cat.class, NSSelectorFromString(@&quot;catClassMethod&quot;));</div><div class="line">SEL classMethodName = method_getName(classMethod);</div><div class="line">NSLog(@&quot;clasMethod: %@&quot;, NSStringFromSelector(classMethodName));</div><div class="line">IMP classMethodNameIMP = method_getImplementation(classMethod);</div><div class="line">classMethodNameIMP();</div><div class="line">// ç»“æœ: clasMethod: catClassMethod</div><div class="line"></div><div class="line">// è·å–ç±»çš„å…ƒç±»</div><div class="line">Class metaClass = objc_getMetaClass(&quot;Cat&quot;);</div><div class="line">NSLog(@&quot;meta class: %@&quot;, metaClass);</div><div class="line">// ç»“æœ: meta class: Cat</div><div class="line">    </div><div class="line">// ä»å…ƒç±»ä¸­è·å–æ‰€æœ‰ç±»æ–¹æ³•</div><div class="line">unsigned int metaMethodListCount = 0;</div><div class="line">Method *metaMethods = class_copyMethodList(metaClass, &amp;metaMethodListCount);</div><div class="line">for (NSInteger i = 0; i &lt; metaMethodListCount; i++) &#123;</div><div class="line">   Method method = metaMethods[i];</div><div class="line">   SEL name = method_getName(method);</div><div class="line">   NSLog(@&quot;metaMethodList: %@&quot;, NSStringFromSelector(name));</div><div class="line">&#125;</div><div class="line">free(metaMethods);</div><div class="line">// ç»“æœ: </div><div class="line">metaMethodList: mews</div><div class="line">metaMethodList: catClassMethod</div><div class="line">// è¯æ˜ç±»æ–¹æ³•çš„ç¡®å­˜æ”¾åœ¨å…ƒç±»ä¸­</div></pre></td></tr></table></figure>
<h3 id="objectéƒ¨åˆ†"><a href="#objectéƒ¨åˆ†" class="headerlink" title="objectéƒ¨åˆ†"></a>objectéƒ¨åˆ†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Cat *cat = Cat.new;</div><div class="line">cat.name = @&quot;å°éº»çƒ¦&quot;;</div><div class="line">cat.weight = 5.0;</div><div class="line">    </div><div class="line">NSLog(@&quot;cat weight: %@&quot;, @(cat.weight)); // cat weight: 5</div><div class="line">objc_removeAssociatedObjects(cat);</div><div class="line">NSLog(@&quot;cat weight after remove: %@&quot;, @(cat.weight)); // cat weight after remove: 0</div><div class="line">    </div><div class="line">Ivar ivar = class_getInstanceVariable(Cat.class, &quot;_color&quot;);</div><div class="line">NSLog(@&quot;internal instance old value: %@&quot;, object_getIvar(cat, ivar)); // internal instance old value: Generic Gray Gamma 2.2 Profile colorspace 0 1</div><div class="line">object_setIvar(cat, ivar, [NSColor orangeColor]);</div><div class="line">NSLog(@&quot;internal instance new value: %@&quot;, object_getIvar(cat, ivar)); // internal instance new value: sRGB IEC61966-2.1 colorspace 1 0.5 0 1</div></pre></td></tr></table></figure>
<h3 id="åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»"><a href="#åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»" class="headerlink" title="åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»"></a>åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">// Cè¯­è¨€å®ç°å¾—getter</div><div class="line">NSString *personNameGetter(id classInstance, SEL _cmd) &#123;</div><div class="line">    Ivar ivar = class_getInstanceVariable([classInstance class], &quot;_name&quot;);</div><div class="line">    return object_getIvar(classInstance, ivar);</div><div class="line">&#125;</div><div class="line">// Cè¯­è¨€å®ç°å¾—setter</div><div class="line">void personNameSetter(id classInstance, SEL _cmd, NSString *newName) &#123;</div><div class="line">    Ivar ivar = class_getInstanceVariable([classInstance class], &quot;_name&quot;);</div><div class="line">    id oldName = object_getIvar(classInstance, ivar);</div><div class="line">    if (oldName != newName) object_setIvar(classInstance, ivar, [newName copy]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ä¸‹é¢å¯¹åº”çš„ç¼–ç å€¼å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£é‡Œé¢æ‰¾åˆ°</div><div class="line">    //ç¼–ç å€¼     å«æ„</div><div class="line">    //c     ä»£è¡¨charç±»å‹</div><div class="line">    //i     ä»£è¡¨intç±»å‹</div><div class="line">    //s     ä»£è¡¨shortç±»å‹</div><div class="line">    //l     ä»£è¡¨longç±»å‹ï¼Œåœ¨64ä½å¤„ç†å™¨ä¸Šä¹Ÿæ˜¯æŒ‰ç…§32ä½å¤„ç†</div><div class="line">    //q     ä»£è¡¨long longç±»å‹</div><div class="line">    //C     ä»£è¡¨unsigned charç±»å‹</div><div class="line">    //I     ä»£è¡¨unsigned intç±»å‹</div><div class="line">    //S     ä»£è¡¨unsigned shortç±»å‹</div><div class="line">    //L     ä»£è¡¨unsigned longç±»å‹</div><div class="line">    //Q     ä»£è¡¨unsigned long longç±»å‹</div><div class="line">    //f     ä»£è¡¨floatç±»å‹</div><div class="line">    //d     ä»£è¡¨doubleç±»å‹</div><div class="line">    //B     ä»£è¡¨C++ä¸­çš„boolæˆ–è€…C99ä¸­çš„_Bool</div><div class="line">    //v     ä»£è¡¨voidç±»å‹</div><div class="line">    //*     ä»£è¡¨char *ç±»å‹</div><div class="line">    //@     ä»£è¡¨å¯¹è±¡ç±»å‹</div><div class="line">    //#     ä»£è¡¨ç±»å¯¹è±¡ (Class)</div><div class="line">    //:     ä»£è¡¨æ–¹æ³•selector (SEL)</div><div class="line">    //[array type]     ä»£è¡¨array</div><div class="line">    //&#123;name=typeâ€¦&#125;     ä»£è¡¨ç»“æ„ä½“</div><div class="line">    //(name=typeâ€¦)     ä»£è¡¨union</div><div class="line">    //bnum     A bit field of num bits</div><div class="line">    //^type     A pointer to type</div><div class="line">    //?     An unknown type (among other things, this code is used for function pointers)</div><div class="line">    </div><div class="line">    Class PersonClass = objc_allocateClassPair(NSObject.class, &quot;Person&quot;, 0);</div><div class="line">    // æ·»åŠ å±æ€§å¿…é¡»åœ¨objc_allocateClassPairå’Œobjc_registerClassPairä¹‹é—´</div><div class="line">    BOOL result = class_addIvar(PersonClass,</div><div class="line">                                &quot;_gender&quot;,</div><div class="line">                                sizeof(NSString *),</div><div class="line">                                log2(sizeof(NSString *)),</div><div class="line">                                &quot;@&quot;);</div><div class="line">    </div><div class="line">    BOOL result2 = class_addIvar(PersonClass,</div><div class="line">                                &quot;_name&quot;,</div><div class="line">                                sizeof(NSString *),</div><div class="line">                                log2(sizeof(NSString *)),</div><div class="line">                                &quot;@&quot;);</div><div class="line">    </div><div class="line">    if (result &amp;&amp; result2) &#123;</div><div class="line">        objc_registerClassPair(PersonClass);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        objc_disposeClassPair(PersonClass);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html</div><div class="line">    // ç»“åˆæ–‡æ¡£, æ·»åŠ å±æ€§éœ€ä»¥Tå¼€å¤´, Vç»“å°¾</div><div class="line">    objc_property_attribute_t type = &#123;&quot;T&quot;, &quot;@\&quot;NSString\&quot;&quot;&#125;;</div><div class="line">    objc_property_attribute_t ownership = &#123;&quot;C&quot;, &quot;&quot;&#125;;</div><div class="line">    objc_property_attribute_t nonatomic = &#123;&quot;N&quot;, &quot;&quot;&#125;;</div><div class="line">    objc_property_attribute_t backingIvar = &#123;&quot;V&quot;, &quot;_name&quot;&#125;;</div><div class="line">    objc_property_attribute_t attrs[] = &#123;type, ownership, nonatomic, backingIvar&#125;;</div><div class="line">    class_addProperty(PersonClass, &quot;name&quot;, attrs, 4);</div><div class="line">    </div><div class="line">    SEL getter = NSSelectorFromString(@&quot;name&quot;);</div><div class="line">    SEL setter = NSSelectorFromString(@&quot;setName:&quot;);</div><div class="line">    // æ·»åŠ æ–¹æ³•</div><div class="line">    class_addMethod(PersonClass, getter, (IMP)personNameGetter, &quot;@@:&quot;); // or use method_getTypeEncoding for last argument</div><div class="line">    class_addMethod(PersonClass, setter, (IMP)personNameSetter, &quot;v@:@&quot;);</div><div class="line">    </div><div class="line"></div><div class="line">// ä»¥ä¸‹ä¸ºæµ‹è¯•è¯¥ç±»</div><div class="line">    Ivar ivar = class_getInstanceVariable(PersonClass, &quot;_gender&quot;);</div><div class="line">    NSLog(@&quot;Person ivar:%@&quot;,[NSString stringWithUTF8String:ivar_getName(ivar)]);</div><div class="line">    // ç»“æœ: Person ivar:_gender</div><div class="line">    </div><div class="line">    </div><div class="line">    objc_property_t prop = class_getProperty(PersonClass, &quot;name&quot;);</div><div class="line">    NSLog(@&quot;Person property:%@&quot;,[NSString stringWithUTF8String:property_getName(prop)]);</div><div class="line">    // ç»“æœ: Person property:name</div><div class="line">    </div><div class="line">    </div><div class="line">    Method method = class_getInstanceMethod(PersonClass, NSSelectorFromString(@&quot;setName:&quot;));</div><div class="line">    NSLog(@&quot;%@&quot;, NSStringFromSelector(method_getName(method)));</div><div class="line">    // ç»“æœ: setName:</div><div class="line">    </div><div class="line">    id person = [PersonClass new];</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</div><div class="line">    [person performSelector:setter withObject:@&quot;Phoenix&quot;];</div><div class="line">    NSLog(@&quot;person name get:%@&quot;, [person performSelector:getter withObject:nil]);</div><div class="line">#pragma clang diagnostic pop</div><div class="line">// ç»“æœ: person name get:Phoenix</div></pre></td></tr></table></figure>
<h3 id="æ›¿æ¢æ–¹æ³•"><a href="#æ›¿æ¢æ–¹æ³•" class="headerlink" title="æ›¿æ¢æ–¹æ³•"></a>æ›¿æ¢æ–¹æ³•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">void newCatMethod() &#123;</div><div class="line">    NSLog(@&quot;~~æ±ª~~&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void replaceMethod() &#123;</div><div class="line">    class_replaceMethod(Cat.class, @selector(mew), (IMP)newCatMethod, NULL);</div><div class="line">    IMP mew = class_getMethodImplementation(Cat.class, @selector(mew));</div><div class="line">    mew();</div><div class="line">    // ç»“æœ: ~~æ±ª~~</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ–¹æ³•éƒ¨åˆ†"><a href="#æ–¹æ³•éƒ¨åˆ†" class="headerlink" title="æ–¹æ³•éƒ¨åˆ†"></a>æ–¹æ³•éƒ¨åˆ†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;</div><div class="line">    Method method = class_getInstanceMethod(Cat.class, @selector(method0:agu1:agu2:agu3:agu4:));</div><div class="line">#pragma clang diagnostic pop</div><div class="line">    </div><div class="line">    SEL methodName = method_getName(method);</div><div class="line">    NSLog(@&quot;%@&quot;, NSStringFromSelector(methodName));</div><div class="line">    // ç»“æœ: method0:agu1:agu2:agu3:agu4:</div><div class="line">    </div><div class="line">    IMP methodIMP = method_getImplementation(method);</div><div class="line">#pragma unused(methodIMP)</div><div class="line">    </div><div class="line">    const char *attrs = method_getTypeEncoding(method);</div><div class="line">    NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:attrs]);</div><div class="line">    // ç»“æœ: @80@0:8@16d24@32@40&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;48</div><div class="line">    </div><div class="line">    unsigned int count = method_getNumberOfArguments(method);</div><div class="line">    NSLog(@&quot;%u&quot;, count);</div><div class="line">    // ç»“æœ: 7 å› ä¸ºè¿˜æœ‰self å’Œ _cmd</div><div class="line">    </div><div class="line">    for (unsigned int i =0 ; i &lt; count; i++) &#123;</div><div class="line">        char result[1024] = &#123;&#125;;</div><div class="line">        method_getArgumentType(method, i, result, 1024);</div><div class="line">        NSLog(@&quot;ç±»å‹æ˜¯ %s&quot;, result);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    char returnType[1024] = &#123;&#125;;</div><div class="line">    method_getReturnType(method, returnType, 1024);</div><div class="line">    NSLog(@&quot;return type:%s&quot;,returnType);</div><div class="line">    </div><div class="line">    struct objc_method_description result7 = *method_getDescription(method);</div><div class="line">    NSLog(@&quot;description ~%@ ~%@&quot;,NSStringFromSelector(result7.name),[NSString stringWithUTF8String:result7.types]);</div></pre></td></tr></table></figure>
<h3 id="äº¤æ¢æ–¹æ³•"><a href="#äº¤æ¢æ–¹æ³•" class="headerlink" title="äº¤æ¢æ–¹æ³•"></a>äº¤æ¢æ–¹æ³•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;</div><div class="line">    Method result0 = class_getInstanceMethod(Cat.class, @selector(method0));</div><div class="line">    Method result1 = class_getInstanceMethod(Cat.class, @selector(method1));</div><div class="line">    Method result2 = class_getInstanceMethod(Cat.class, @selector(method2));</div><div class="line">    method_setImplementation(result0, method_getImplementation(result1));</div><div class="line">    </div><div class="line">    method_getImplementation(result0)();</div><div class="line">    </div><div class="line">    method_exchangeImplementations(result0, result2);</div><div class="line">    </div><div class="line">    method_getImplementation(result0)();</div><div class="line">    method_getImplementation(result2)();</div><div class="line">#pragma clang diagnostic pop</div><div class="line"></div><div class="line">// ç»“æœ:  </div><div class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;1:-[Cat method1]</div><div class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;2:-[Cat method2]</div><div class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;1:-[Cat method1]</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/06/æ–°æµªå¾®åšOnePassword-SSOç™»å½•/">æ–°æµªå¾®åšOnePassword SSOç™»å½•</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jun 6, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>å‘ç°VVeboçš„SSOç™»å½•åœ¨Webviewä½¿ç”¨äº†1Password, è§‰å¾—å¯ä»¥ç”¨è¿è¡Œæ—¶æ¥å®ç°.<a href="http://oph74zx6j.bkt.clouddn.com/SSO.gif" target="_blank" rel="external">ç‚¹å‡»æŸ¥çœ‹æ•ˆæœå›¾</a></p>
<p>å®ç°æ€è·¯:</p>
<ol>
<li>ä»¥è‹¹æœåˆšå…¬å¼€çš„å·¥å…·UIDebuggingInformationOverlayæŸ¥çœ‹å¾®åšSDKä¸­çš„controllerå’Œview</li>
<li>ä»¥è¿è¡Œæ—¶method swizzling æ›¿æ¢ç³»ç»ŸviewWillAppearæ–¹æ³•, æ‹¦æˆªåˆ°å¾®åšçš„æ§åˆ¶å™¨å, åœ¨ç›¸åº”ä½ç½®æ·»åŠ 1PasswordæŒ‰é’®</li>
<li>1Passwordå›è°ƒåä»¥Safariè°ƒè¯•æ­¤Webview,æŸ¥çœ‹h5çš„elementID, å°†è´¦æˆ·å¯†ç æ·»åŠ è¿›å», è‡ªåŠ¨ç™»å½•</li>
</ol>
<h3 id="å…³äºå¾®åšSDK-ç™»å½•æ¥å£å°±ä¸è¯¦è¿°äº†"><a href="#å…³äºå¾®åšSDK-ç™»å½•æ¥å£å°±ä¸è¯¦è¿°äº†" class="headerlink" title="å…³äºå¾®åšSDK, ç™»å½•æ¥å£å°±ä¸è¯¦è¿°äº†"></a>å…³äºå¾®åšSDK, ç™»å½•æ¥å£å°±ä¸è¯¦è¿°äº†</h3><p>å°±æ˜¯è¦æ³¨æ„å¾®åšSDKæ˜¯åœ¨iOSæ²¡æœ‰å®‰è£…å¾®åšå®¢æˆ·ç«¯çš„æ—¶å€™æ‰ä¼šè°ƒç”¨Webviewç™»å½•</p>
<h3 id="UIDebuggingInformationOverlayçš„ä½¿ç”¨"><a href="#UIDebuggingInformationOverlayçš„ä½¿ç”¨" class="headerlink" title="UIDebuggingInformationOverlayçš„ä½¿ç”¨"></a>UIDebuggingInformationOverlayçš„ä½¿ç”¨</h3><p>UIDebuggingInformationOverlayæ˜¯è‹¹æœåˆšå…¬å¼€çš„UIè°ƒè¯•å·¥å…·<br>ä½¿ç”¨å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> overlayClass = <span class="type">NSClassFromString</span>(<span class="string">"UIDebuggingInformationOverlay"</span>) <span class="keyword">as</span>? <span class="type">UIWindow</span>.<span class="type">Type</span></div><div class="line"><span class="number">_</span> = overlayClass?.perform(<span class="type">NSSelectorFromString</span>(<span class="string">"prepareDebuggingOverlay"</span>))</div><div class="line"><span class="keyword">let</span> overlay = overlayClass?.perform(<span class="type">NSSelectorFromString</span>(<span class="string">"overlay"</span>)).takeUnretainedValue() <span class="keyword">as</span>? <span class="type">UIWindow</span></div><div class="line"><span class="number">_</span> = overlay?.perform(<span class="type">NSSelectorFromString</span>(<span class="string">"toggleVisibility"</span>))</div></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥åœ¨æ‰‹æœºä¸Šçœ‹åˆ°å¯¹åº”çš„controllerå’Œviewäº†:</p>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/uidebugvc.jpg" width="50%" height="50%"></p><br><p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/uidebugview.jpg" width="50%" height="50%"></p>

<p>æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡!<br>OK, ç°åœ¨æˆ‘ä»¬å¾ˆæ–¹ä¾¿çš„æ‹¿åˆ°äº†æ§åˆ¶å™¨å’Œviewçš„åå­—â€WBSDKAuthorizeWebViewControllerâ€ â€œWBSDKWebViewâ€,  å½“ç„¶ä¹Ÿæœ‰å…¶ä»–æ–¹å¼, ä¸å¤šè¯´.</p>
<h3 id="swiftä¸­çš„method-swizzling"><a href="#swiftä¸­çš„method-swizzling" class="headerlink" title="swiftä¸­çš„method swizzling"></a>swiftä¸­çš„method swizzling</h3><p>swift3ä¸­dispatch_once_t è¢«å–æ¶ˆäº†, å› æ­¤ç”¨å…¨å±€å¸¸é‡æ¥å®ç°åªæ‰§è¡Œä¸€æ¬¡swizzling</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">let</span> controllerMethodSwizzling: (<span class="type">UIViewController</span>.<span class="type">Type</span>) -&gt; () = &#123; viewController <span class="keyword">in</span></div><div class="line">    </div><div class="line">    <span class="keyword">let</span> originalSelector = #selector(viewController.viewWillAppear(<span class="number">_</span>:))</div><div class="line">    <span class="keyword">let</span> swizzledSelector = #selector(viewController.proj_viewWillAppear(animated:))</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> originalMethod = class_getInstanceMethod(viewController, originalSelector)</div><div class="line">    <span class="keyword">let</span> swizzledMethod = class_getInstanceMethod(viewController, swizzledSelector)</div><div class="line">    </div><div class="line">    method_exchangeImplementations(originalMethod, swizzledMethod)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIViewController</span> </span>&#123;</div><div class="line">    open <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">initialize</span>() </span>&#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">self</span> === <span class="type">UIViewController</span>.<span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">        controllerMethodSwizzling(<span class="keyword">self</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">proj_viewWillAppear</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">        <span class="keyword">self</span>.proj_viewWillAppear(animated: animated)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯! åœ¨initializeæ–¹æ³•å¤„æŠ¥äº†ä¸ªè­¦å‘Š, xcodeè·Ÿæˆ‘è®²è¿™æ–¹æ³•swiftä¸ä¸€å®šè°ƒ, è€Œä¸”ä»¥åå½»åº•ä¸è®©åœ¨swifté‡Œç”¨äº†.å¥½å§, é‚£æˆ‘åœ¨applicationDidFinishLaunchingWithOptionsè°ƒæ€»å¯ä»¥äº†å§.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">   controllerMethodSwizzling(<span class="type">UIViewController</span>.<span class="keyword">self</span>)     </div><div class="line">   <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è°ƒç”¨OnePassword"><a href="#è°ƒç”¨OnePassword" class="headerlink" title="è°ƒç”¨OnePassword"></a>è°ƒç”¨OnePassword</h3><p>ç°åœ¨æˆ‘ä»¬æ‹¦æˆªåˆ°äº†å¾®åšæ§åˆ¶å™¨çš„viewWillAppearæ–¹æ³•äº†, æ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›åŸºæœ¬æ“ä½œäº†.<br>1Passwordçš„iOSä»£ç åœ°å€<a href="https://github.com/agilebits/onepassword-app-extension" target="_blank" rel="external">https://github.com/agilebits/onepassword-app-extension</a></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">proj_viewWillAppear</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">   <span class="keyword">self</span>.proj_viewWillAppear(animated: animated)</div><div class="line">        </div><div class="line">   <span class="keyword">let</span> viewControllerName = <span class="type">NSStringFromClass</span>(type(of: <span class="keyword">self</span>))</div><div class="line">        </div><div class="line">   <span class="keyword">if</span> viewControllerName == <span class="string">"WBSDKAuthorizeWebViewController"</span> &#123;</div><div class="line">            </div><div class="line">	  <span class="keyword">let</span> hasOnePassword = <span class="type">UIApplication</span>.shared.canOpenURL(<span class="type">URL</span>(string: <span class="string">"org-appextension-feature-password-management://"</span>)!)</div><div class="line">       </div><div class="line">	  <span class="keyword">guard</span> hasOnePassword <span class="keyword">else</span> &#123;</div><div class="line">	      <span class="keyword">return</span></div><div class="line">	  &#125;</div><div class="line">            </div><div class="line">     <span class="keyword">self</span>.navigationItem.rightBarButtonItem = <span class="type">UIBarButtonItem</span>(image: <span class="type">UIImage</span>(named: <span class="string">"onepassword"</span>),</div><div class="line">                                                              landscapeImagePhone: <span class="literal">nil</span>,</div><div class="line">                                                              style: .done,</div><div class="line">                                                              target: <span class="keyword">self</span>,</div><div class="line">                                                              action: #selector(onePassword(<span class="number">_</span>:)))</div><div class="line">&#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">onePassword</span><span class="params">(<span class="number">_</span> sender: AnyObject)</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> view <span class="keyword">in</span> <span class="keyword">self</span>.view.subviews &#123;</div><div class="line">            <span class="keyword">if</span> <span class="type">NSStringFromClass</span>(type(of: view)) == <span class="string">"WBSDKWebView"</span> &#123;</div><div class="line">            </div><div class="line">                <span class="keyword">for</span> subview <span class="keyword">in</span> view.subviews &#123;    </div><div class="line">                    <span class="keyword">let</span> viewClassName = <span class="type">NSStringFromClass</span>(type(of: subview))</div><div class="line">                    <span class="keyword">if</span> viewClassName == <span class="string">"UIWebView"</span> &#123;</div><div class="line">                    </div><div class="line">                        <span class="keyword">let</span> webview = subview <span class="keyword">as</span>! <span class="type">UIWebView</span></div><div class="line">                        <span class="type">OnePasswordExtension</span>.shared().findLogin(forURLString: <span class="string">"weibo.com"</span>, <span class="keyword">for</span>: <span class="keyword">self</span></div><div class="line">                            , sender: sender, completion: &#123; (success, error) <span class="keyword">in</span></div><div class="line">                                <span class="keyword">if</span> (success != <span class="literal">nil</span>) &#123;</div><div class="line">                                    <span class="keyword">let</span> info = success <span class="keyword">as</span>! <span class="type">Dictionary</span>&lt;<span class="type">String</span>, <span class="type">Any</span>&gt;</div><div class="line">                                    <span class="keyword">let</span> username: <span class="type">String</span> = info[<span class="string">"username"</span>] <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">                                    <span class="keyword">let</span> password: <span class="type">String</span> = info[<span class="string">"password"</span>] <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">                                    webview.stringByEvaluatingJavaScript(from: <span class="string">"document.getElementById('loginName').value = '<span class="subst">\(username)</span>'"</span>)</div><div class="line">                                    webview.stringByEvaluatingJavaScript(from: <span class="string">"document.getElementById('loginPassword').value = '<span class="subst">\(password)</span>'"</span>)</div><div class="line">                                    webview.stringByEvaluatingJavaScript(from: <span class="string">"document.getElementById('loginAction').click()"</span>)</div><div class="line">                                    </div><div class="line">                                &#125;</div><div class="line">                        &#125;)</div><div class="line">                        <span class="keyword">break</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨è·å–äº†è´¦æˆ·å’Œå¯†ç ä¹‹å, ç”¨Safariè°ƒè¯•Webviewå¯è·å¾—elementID, ç„¶åä»¥Webviewæ‰§è¡Œjsä»£ç å³å¯</p>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/webviewsafari.png"></p>

<p>è¿™ç§åœºæ™¯ä¸å¤ªå¸¸è§, å®ç°æŠ€æœ¯éƒ½ä¸éš¾, ä¸»è¦æä¾›ä¸€ä¸ªæ€è·¯.</p>
<p>__åŸåˆ›æ–‡ç« , è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/02/18/GCDæ­»é”/">GCDæ­»é”</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Feb 18, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>ä¸€ç›´æƒ³å†™ä¸€ç¯‡å…³äºGCDæ­»é”é—®é¢˜çš„æ–‡ç« , ä½†æ˜¯åæ¥å‘ç°äº†ä¸€ç¯‡æ–‡ç« è®²å¾—å¾ˆå¥½, è¿˜æ˜¯ç›´æ¥è½¬è½½å§(ä½†æ˜¯æŠŠOCæ”¹ä¸ºSwift 3äº†, å¹¶æ·»åŠ äº†ä¸€ä¸ªæ¡ˆä¾‹). åŸæ–‡ä½œè€…: <a href="http://www.brighttj.com/ios/ios-gcd-deadlock.html" target="_blank" rel="external">brighttj(@saitjr)</a></p>
<p>æ­»é”ä¸€ç›´éƒ½æ˜¯åœ¨ä½¿ç”¨å¤šçº¿ç¨‹æ—¶ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ä¸ªé—®é¢˜ã€‚ä»¥å‰å¯¹åŒæ­¥ã€å¼‚æ­¥ï¼Œä¸²è¡Œã€å¹¶è¡Œåªæœ‰ä¸€ä¸ªæ¨¡ç³Šçš„æ¦‚å¿µï¼Œæƒ³æƒ³ä¹Ÿæ˜¯æ—¶å€™æ•´ç†ä¸€ä¸‹äº†ã€‚å†çœ‹çœ‹ä¹‹å‰çš„åšå®¢ï¼Œå·²ç»å¾ˆä¹…æ²¡æœ‰å¹²è´§äº†ã€è¯´å¾—å¥½åƒä¹‹å‰æœ‰å¹²è´§ä¸€æ ·ã€‘ï¼Œæ‰€ä»¥ï¼Œè¿™ç¯‡åšå®¢ï¼Œæˆ‘å°½æœ€å¤§åŠªåŠ›ï¼Œä¹Ÿå€Ÿé‰´äº†å¾ˆå¤šå…¶ä»–åšå®¢ä¸­çš„ä¾‹å­ï¼Œæ¥è®²è§£GCDæ­»é”é—®é¢˜ã€‚</p>
<h2 id="ä¸²è¡Œä¸å¹¶è¡Œ"><a href="#ä¸²è¡Œä¸å¹¶è¡Œ" class="headerlink" title="ä¸²è¡Œä¸å¹¶è¡Œ"></a>ä¸²è¡Œä¸å¹¶è¡Œ</h2><p>åœ¨ä½¿ç”¨GCDçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæŠŠéœ€è¦å¤„ç†çš„ä»»åŠ¡æ”¾åˆ°Blockä¸­ï¼Œç„¶åå°†ä»»åŠ¡è¿½åŠ åˆ°ç›¸åº”çš„é˜Ÿåˆ—é‡Œé¢ï¼Œè¿™ä¸ªé˜Ÿåˆ—ï¼Œå«åšDispatch Queueã€‚ç„¶è€Œï¼Œå­˜åœ¨äºä¸¤ç§Dispatch Queueï¼Œä¸€ç§æ˜¯è¦ç­‰å¾…ä¸Šä¸€ä¸ªæ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªçš„Serial Dispatch Queueï¼Œè¿™å«åšä¸²è¡Œé˜Ÿåˆ—ï¼›å¦ä¸€ç§ï¼Œåˆ™æ˜¯ä¸éœ€è¦ä¸Šä¸€ä¸ªæ‰§è¡Œå®Œï¼Œå°±èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªçš„Concurrent Dispatch Queueï¼Œå«åšå¹¶è¡Œé˜Ÿåˆ—ã€‚è¿™ä¸¤ç§ï¼Œå‡éµå¾ªFIFOåŸåˆ™ã€‚</p>
<p><strong>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸‰ä¸ªä»»åŠ¡ä¸­è¾“å‡º1ã€2ã€3ï¼Œä¸²è¡Œé˜Ÿåˆ—è¾“å‡ºæ˜¯æœ‰åºçš„1ã€2ã€3ï¼Œä½†æ˜¯å¹¶è¡Œé˜Ÿåˆ—çš„å…ˆåé¡ºåºå°±ä¸ä¸€å®šäº†ã€‚</strong></p>
<p>é‚£ä¹ˆï¼Œå¹¶è¡Œé˜Ÿåˆ—åˆæ˜¯æ€ä¹ˆåœ¨æ‰§è¡Œå‘¢ï¼Ÿ</p>
<p>è™½ç„¶å¯ä»¥åŒæ—¶å¤šä¸ªä»»åŠ¡çš„å¤„ç†ï¼Œä½†æ˜¯å¹¶è¡Œé˜Ÿåˆ—çš„å¤„ç†é‡ï¼Œè¿˜æ˜¯è¦æ ¹æ®å½“å‰ç³»ç»ŸçŠ¶æ€æ¥ã€‚å¦‚æœå½“å‰ç³»ç»ŸçŠ¶æ€æœ€å¤šå¤„ç†2ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆ1ã€2ä¼šæ’åœ¨å‰é¢ï¼Œ3ä»€ä¹ˆæ—¶å€™æ“ä½œï¼Œå°±çœ‹1æˆ–è€…2è°å…ˆå®Œæˆï¼Œç„¶å3æ¥åœ¨åé¢ã€‚</p>
<p>ä¸²è¡Œå’Œå¹¶è¡Œå°±ç®€å•è¯´åˆ°è¿™é‡Œï¼Œå…³äºå®ƒä»¬çš„æŠ€æœ¯ç‚¹å…¶å®è¿˜æœ‰å¾ˆå¤šï¼Œå¯ä»¥è‡ªè¡Œäº†è§£ã€‚</p>
<h2 id="åŒæ­¥ä¸å¼‚æ­¥"><a href="#åŒæ­¥ä¸å¼‚æ­¥" class="headerlink" title="åŒæ­¥ä¸å¼‚æ­¥"></a>åŒæ­¥ä¸å¼‚æ­¥</h2><p>ä¸²è¡Œä¸å¹¶è¡Œé’ˆå¯¹çš„æ˜¯é˜Ÿåˆ—ï¼Œè€ŒåŒæ­¥ä¸å¼‚æ­¥ï¼Œé’ˆå¯¹çš„åˆ™æ˜¯çº¿ç¨‹ã€‚æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼ŒåŒæ­¥çº¿ç¨‹è¦é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¿…é¡»è¦ç­‰å¾…åŒæ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œï¼Œè¿”å›ä»¥åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä»»åŠ¡ï¼›è€Œå¼‚æ­¥çº¿ç¨‹åˆ™æ˜¯ä¸ç”¨ç­‰å¾…ã€‚</p>
<p>ä»…å‡­è¿™å‡ å¥è¯è¿˜æ˜¯å¾ˆéš¾ç†è§£ï¼Œæ‰€ä»¥ä¹‹åå‡†å¤‡äº†å¾ˆå¤šæ¡ˆä¾‹ï¼Œå¯ä»¥è¾¹åˆ†æè¾¹ç†è§£ã€‚</p>
<h2 id="GCD-API"><a href="#GCD-API" class="headerlink" title="GCD API"></a>GCD API</h2><p>GCD APIå¾ˆå¤šï¼Œè¿™é‡Œä»…ä»‹ç»æœ¬æ–‡ç”¨åˆ°çš„ã€‚</p>
<h4 id="1-ç³»ç»Ÿæ ‡å‡†æä¾›çš„ä¸¤ä¸ªé˜Ÿåˆ—"><a href="#1-ç³»ç»Ÿæ ‡å‡†æä¾›çš„ä¸¤ä¸ªé˜Ÿåˆ—" class="headerlink" title="1.ç³»ç»Ÿæ ‡å‡†æä¾›çš„ä¸¤ä¸ªé˜Ÿåˆ—"></a>1.ç³»ç»Ÿæ ‡å‡†æä¾›çš„ä¸¤ä¸ªé˜Ÿåˆ—</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å…¨å±€é˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span></div><div class="line"></div><div class="line"><span class="type">DispatchQueue</span>.global() </div><div class="line"></div><div class="line"><span class="comment">// ä¸»é˜Ÿåˆ—ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œå› ä¸ºä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</span></div><div class="line"></div><div class="line"><span class="type">DispatchQueue</span>.main</div></pre></td></tr></table></figure>
<h4 id="2-é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±ç”Ÿæˆé˜Ÿåˆ—"><a href="#2-é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±ç”Ÿæˆé˜Ÿåˆ—" class="headerlink" title="2.é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±ç”Ÿæˆé˜Ÿåˆ—"></a>2.é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±ç”Ÿæˆé˜Ÿåˆ—</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// é»˜è®¤æ˜¯ä¸²è¡Œé˜Ÿåˆ—</span></div><div class="line"><span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.serialQueue"</span>) </div><div class="line"></div><div class="line"> <span class="comment">// è¿™æ˜¯ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span></div><div class="line"><span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.concurrentQueue"</span>, attributes: .concurrent)</div></pre></td></tr></table></figure>
<h4 id="3-æ¥ä¸‹æ¥æ˜¯åŒæ­¥ä¸å¼‚æ­¥çº¿ç¨‹çš„åˆ›å»ºï¼š"><a href="#3-æ¥ä¸‹æ¥æ˜¯åŒæ­¥ä¸å¼‚æ­¥çº¿ç¨‹çš„åˆ›å»ºï¼š" class="headerlink" title="3.æ¥ä¸‹æ¥æ˜¯åŒæ­¥ä¸å¼‚æ­¥çº¿ç¨‹çš„åˆ›å»ºï¼š"></a>3.æ¥ä¸‹æ¥æ˜¯åŒæ­¥ä¸å¼‚æ­¥çº¿ç¨‹çš„åˆ›å»ºï¼š</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">queue.sync &#123;...&#125; <span class="comment">// åŒæ­¥çº¿ç¨‹</span></div><div class="line"></div><div class="line">queue.async &#123;...&#125; <span class="comment">// å¼‚æ­¥çº¿ç¨‹</span></div></pre></td></tr></table></figure>
<h2 id="æ¡ˆä¾‹ä¸åˆ†æ"><a href="#æ¡ˆä¾‹ä¸åˆ†æ" class="headerlink" title="æ¡ˆä¾‹ä¸åˆ†æ"></a>æ¡ˆä¾‹ä¸åˆ†æ</h2><p>å‡è®¾ä½ å·²ç»åŸºæœ¬äº†è§£äº†ä¸Šé¢æåˆ°çš„çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥è¿›å…¥æ¡ˆä¾‹è®²è§£é˜¶æ®µã€‚</p>
<h4 id="æ¡ˆä¾‹ä¸€"><a href="#æ¡ˆä¾‹ä¸€" class="headerlink" title="æ¡ˆä¾‹ä¸€:"></a>æ¡ˆä¾‹ä¸€:</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">print</span>(<span class="number">1</span>)  <span class="comment">// ä»»åŠ¡1</span></div><div class="line"></div><div class="line"><span class="type">DispatchQueue</span>.main.sync &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="number">2</span>)  <span class="comment">// ä»»åŠ¡2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="number">3</span>)  <span class="comment">// ä»»åŠ¡3</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1</div></pre></td></tr></table></figure>
<p>åˆ†æ</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">.syncè¡¨ç¤ºæ˜¯ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼›</div><div class="line"></div><div class="line"><span class="type">DispatchQueue</span>.main è¡¨ç¤ºè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ä¸»é˜Ÿåˆ—ï¼›</div><div class="line"></div><div class="line">ä»»åŠ¡<span class="number">2</span>æ˜¯åŒæ­¥çº¿ç¨‹çš„ä»»åŠ¡ã€‚</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œè¿™æ˜¯è‚¯å®šæ²¡é—®é¢˜çš„ï¼Œåªæ˜¯æ¥ä¸‹æ¥ï¼Œç¨‹åºé‡åˆ°äº†åŒæ­¥çº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒä¼šè¿›å…¥ç­‰å¾…ï¼Œç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œï¼Œç„¶åæ‰§è¡Œä»»åŠ¡3ã€‚ä½†è¿™æ˜¯é˜Ÿåˆ—ï¼Œæœ‰ä»»åŠ¡æ¥ï¼Œå½“ç„¶ä¼šå°†ä»»åŠ¡åŠ åˆ°é˜Ÿå°¾ï¼Œç„¶åéµå¾ªFIFOåŸåˆ™æ‰§è¡Œä»»åŠ¡ã€‚é‚£ä¹ˆï¼Œç°åœ¨ä»»åŠ¡2å°±ä¼šè¢«åŠ åˆ°æœ€åï¼Œä»»åŠ¡3æ’åœ¨äº†ä»»åŠ¡2å‰é¢ï¼Œé—®é¢˜æ¥äº†ï¼š</p>
<p><strong>ä»»åŠ¡3è¦ç­‰ä»»åŠ¡2æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œä»»åŠ¡2ç”±æ’åœ¨ä»»åŠ¡3åé¢ï¼Œæ„å‘³ç€ä»»åŠ¡2è¦åœ¨ä»»åŠ¡3æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œæ‰€ä»¥ä»–ä»¬è¿›å…¥äº†äº’ç›¸ç­‰å¾…çš„å±€é¢ã€‚ã€æ—¢ç„¶è¿™æ ·ï¼Œé‚£å¹²è„†å°±å¡åœ¨è¿™é‡Œå§ã€‘è¿™å°±æ˜¯æ­»é”ã€‚</strong></p>
<p><img src="https://ae01.alicdn.com/kf/HTB1jNGnacfrK1Rjy1Xdq6yemFXat.jpg" alt="deadlock1"></p>
<h4 id="æ¡ˆä¾‹äºŒï¼š"><a href="#æ¡ˆä¾‹äºŒï¼š" class="headerlink" title="æ¡ˆä¾‹äºŒï¼š"></a>æ¡ˆä¾‹äºŒï¼š</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">print</span>(<span class="number">1</span>)  <span class="comment">// ä»»åŠ¡1</span></div><div class="line"></div><div class="line"><span class="type">DispatchQueue</span>.global(qos: .userInitiated).sync &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="number">2</span>)  <span class="comment">// ä»»åŠ¡2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="number">3</span>)  <span class="comment">// ä»»åŠ¡3</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line"></div><div class="line">2</div><div class="line"></div><div class="line">3</div></pre></td></tr></table></figure>
<p>åˆ†æï¼š</p>
<p>é¦–å…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œæ¥ä¸‹æ¥ä¼šé‡åˆ°ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œç¨‹åºä¼šè¿›å…¥ç­‰å¾…ã€‚ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆä»¥åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä»»åŠ¡3ã€‚ä»dispatch_get_global_queueå¯ä»¥çœ‹å‡ºï¼Œä»»åŠ¡2è¢«åŠ å…¥åˆ°äº†å…¨å±€çš„å¹¶è¡Œé˜Ÿåˆ—ä¸­ï¼Œå½“å¹¶è¡Œé˜Ÿåˆ—æ‰§è¡Œå®Œä»»åŠ¡2ä»¥åï¼Œè¿”å›åˆ°ä¸»é˜Ÿåˆ—ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡3ã€‚</p>
<p><img src="https://ae01.alicdn.com/kf/HTB10W5padzvK1RkSnfoq6zMwVXaO.jpg" alt="deadlock2"></p>
<h4 id="æ¡ˆä¾‹ä¸‰ï¼š"><a href="#æ¡ˆä¾‹ä¸‰ï¼š" class="headerlink" title="æ¡ˆä¾‹ä¸‰ï¼š"></a>æ¡ˆä¾‹ä¸‰ï¼š</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.serialQueue"</span>)</div><div class="line">        </div><div class="line"><span class="built_in">print</span>(<span class="number">1</span>)  <span class="comment">// ä»»åŠ¡1</span></div><div class="line">   </div><div class="line">queue.async &#123;</div><div class="line">  </div><div class="line">  <span class="built_in">print</span>(<span class="number">2</span>)  <span class="comment">// ä»»åŠ¡2</span></div><div class="line">  </div><div class="line">  queue.sync &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="number">3</span>)  <span class="comment">// ä»»åŠ¡3</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="built_in">print</span>(<span class="number">4</span>)  <span class="comment">// ä»»åŠ¡4</span></div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="built_in">print</span>(<span class="number">5</span>)  <span class="comment">// ä»»åŠ¡5</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line"></div><div class="line">5</div><div class="line"></div><div class="line">2</div><div class="line"></div><div class="line">// 5å’Œ2çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p>åˆ†æï¼š</p>
<p>è¿™ä¸ªæ¡ˆä¾‹æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ä¸²è¡Œæˆ–å¹¶è¡Œé˜Ÿåˆ—ï¼Œè€Œæ˜¯è‡ªå·±é€šè¿‡DispatchQueue(label: â€œâ€)å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚</p>
<p><strong><br>æ‰§è¡Œä»»åŠ¡1ï¼›
</strong><br><strong><br>é‡åˆ°å¼‚æ­¥çº¿ç¨‹ï¼Œå°†ã€ä»»åŠ¡2ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€‘åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ä¸­ã€‚å› ä¸ºæ˜¯å¼‚æ­¥çº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡5ä¸å¿…ç­‰å¾…å¼‚æ­¥çº¿ç¨‹ä¸­çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼›
</strong><br><strong><br>å› ä¸ºä»»åŠ¡5ä¸å¿…ç­‰å¾…ï¼Œæ‰€ä»¥2å’Œ5çš„è¾“å‡ºé¡ºåºä¸èƒ½ç¡®å®šï¼›
</strong><br><strong><br>ä»»åŠ¡2æ‰§è¡Œå®Œä»¥åï¼Œé‡åˆ°åŒæ­¥çº¿ç¨‹ï¼Œè¿™æ—¶ï¼Œå°†ä»»åŠ¡3åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ï¼›
</strong><br><strong><br>åˆå› ä¸ºä»»åŠ¡4æ¯”ä»»åŠ¡3æ—©åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥ï¼Œä»»åŠ¡3è¦ç­‰å¾…ä»»åŠ¡4å®Œæˆä»¥åï¼Œæ‰èƒ½æ‰§è¡Œã€‚ä½†æ˜¯ä»»åŠ¡3æ‰€åœ¨çš„åŒæ­¥çº¿ç¨‹ä¼šé˜»å¡ï¼Œæ‰€ä»¥ä»»åŠ¡4å¿…é¡»ç­‰ä»»åŠ¡3æ‰§è¡Œå®Œä»¥åå†æ‰§è¡Œã€‚è¿™å°±åˆé™·å…¥äº†æ— é™çš„ç­‰å¾…ä¸­ï¼Œé€ æˆæ­»é”ã€‚
</strong></p>
<p><img src="https://ae01.alicdn.com/kf/HTB1EPupacnrK1RjSspkq6yuvXXaW.jpg" alt="deadlock3"></p>
<h4 id="æ¡ˆä¾‹å››"><a href="#æ¡ˆä¾‹å››" class="headerlink" title="æ¡ˆä¾‹å››:"></a>æ¡ˆä¾‹å››:</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">print</span>(<span class="number">1</span>)  <span class="comment">// ä»»åŠ¡1</span></div><div class="line">        </div><div class="line"><span class="type">DispatchQueue</span>.global(qos: .userInitiated).async &#123;</div><div class="line">  </div><div class="line">  <span class="built_in">print</span>(<span class="number">2</span>)  <span class="comment">// ä»»åŠ¡2</span></div><div class="line">  </div><div class="line">  <span class="type">DispatchQueue</span>.main.sync &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="number">3</span>)  <span class="comment">// ä»»åŠ¡3</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="built_in">print</span>(<span class="number">4</span>)  <span class="comment">// ä»»åŠ¡4</span></div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="built_in">print</span>(<span class="number">5</span>)  <span class="comment">// ä»»åŠ¡5</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line"></div><div class="line">2</div><div class="line"></div><div class="line">5</div><div class="line"></div><div class="line">3</div><div class="line"></div><div class="line">4</div><div class="line"></div><div class="line">// 5å’Œ2çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p>åˆ†æï¼š</p>
<p>é¦–å…ˆï¼Œå°†ã€ä»»åŠ¡1ã€å¼‚æ­¥çº¿ç¨‹ã€ä»»åŠ¡5ã€‘åŠ å…¥Main Queueä¸­ï¼Œå¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯ï¼šã€ä»»åŠ¡2ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€‘ã€‚</p>
<p>æ‰€ä»¥ï¼Œå…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œç„¶åå°†å¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡åŠ å…¥åˆ°Global Queueä¸­ï¼Œå› ä¸ºå¼‚æ­¥çº¿ç¨‹ï¼Œæ‰€ä»¥ä»»åŠ¡5ä¸ç”¨ç­‰å¾…ï¼Œç»“æœå°±æ˜¯2å’Œ5çš„è¾“å‡ºé¡ºåºä¸ä¸€å®šã€‚</p>
<p>ç„¶åå†çœ‹å¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œé¡ºåºã€‚ä»»åŠ¡2æ‰§è¡Œå®Œä»¥åï¼Œé‡åˆ°åŒæ­¥çº¿ç¨‹ã€‚å°†åŒæ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡åŠ å…¥åˆ°Main Queueä¸­ï¼Œè¿™æ—¶åŠ å…¥çš„ä»»åŠ¡3åœ¨ä»»åŠ¡5çš„åé¢ã€‚</p>
<p>å½“ä»»åŠ¡3æ‰§è¡Œå®Œä»¥åï¼Œæ²¡æœ‰äº†é˜»å¡ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œä»»åŠ¡4ã€‚</p>
<p>ä»ä»¥ä¸Šçš„åˆ†ææ¥çœ‹ï¼Œå¾—åˆ°çš„å‡ ä¸ªç»“æœï¼š1æœ€å…ˆæ‰§è¡Œï¼›2å’Œ5é¡ºåºä¸ä¸€å®šï¼›4ä¸€å®šåœ¨3åé¢</p>
<p><img src="https://ae01.alicdn.com/kf/HTB1V4emanjxK1Rjy0Fnq6yBaFXa1.jpg" alt="deadlock4"></p>
<h4 id="æ¡ˆä¾‹äº”ï¼š"><a href="#æ¡ˆä¾‹äº”ï¼š" class="headerlink" title="æ¡ˆä¾‹äº”ï¼š"></a>æ¡ˆä¾‹äº”ï¼š</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="type">DispatchQueue</span>.global(qos: .userInitiated).async &#123;</div><div class="line">            </div><div class="line">  <span class="built_in">print</span>(<span class="number">1</span>)  <span class="comment">// ä»»åŠ¡1</span></div><div class="line">  </div><div class="line">  <span class="type">DispatchQueue</span>.main.sync &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="number">2</span>)  <span class="comment">// ä»»åŠ¡2</span></div><div class="line">      </div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="built_in">print</span>(<span class="number">3</span>)  <span class="comment">// ä»»åŠ¡3</span></div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="built_in">print</span>(<span class="number">4</span>)  <span class="comment">// ä»»åŠ¡4</span></div><div class="line">   </div><div class="line"><span class="keyword">while</span> <span class="literal">true</span> &#123;</div><div class="line">  </div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="built_in">print</span>(<span class="number">5</span>)  <span class="comment">// ä»»åŠ¡5</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line"></div><div class="line">4</div><div class="line"></div><div class="line">// 1å’Œ4çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p>åˆ†æï¼š</p>
<p>å’Œä¸Šé¢å‡ ä¸ªæ¡ˆä¾‹çš„åˆ†æç±»ä¼¼ï¼Œå…ˆæ¥çœ‹çœ‹éƒ½æœ‰å“ªäº›ä»»åŠ¡åŠ å…¥äº†Main Queueï¼šã€å¼‚æ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€æ­»å¾ªç¯ã€ä»»åŠ¡5ã€‘ã€‚</p>
<p>åœ¨åŠ å…¥åˆ°Global Queueå¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æœ‰ï¼šã€ä»»åŠ¡1ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡3ã€‘ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå°±æ˜¯å¼‚æ­¥çº¿ç¨‹ï¼Œä»»åŠ¡4ä¸ç”¨ç­‰å¾…ï¼Œæ‰€ä»¥ç»“æœä»»åŠ¡1å’Œä»»åŠ¡4é¡ºåºä¸ä¸€å®šã€‚</p>
<p>ä»»åŠ¡4å®Œæˆåï¼Œç¨‹åºè¿›å…¥æ­»å¾ªç¯ï¼ŒMain Queueé˜»å¡ã€‚ä½†æ˜¯åŠ å…¥åˆ°Global Queueçš„å¼‚æ­¥çº¿ç¨‹ä¸å—å½±å“ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡1åé¢çš„åŒæ­¥çº¿ç¨‹ã€‚</p>
<p>åŒæ­¥çº¿ç¨‹ä¸­ï¼Œå°†ä»»åŠ¡2åŠ å…¥åˆ°äº†ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸”ï¼Œä»»åŠ¡3ç­‰å¾…ä»»åŠ¡2å®Œæˆä»¥åæ‰èƒ½æ‰§è¡Œã€‚è¿™æ—¶çš„ä¸»çº¿ç¨‹ï¼Œå·²ç»è¢«æ­»å¾ªç¯é˜»å¡äº†ã€‚æ‰€ä»¥ä»»åŠ¡2æ— æ³•æ‰§è¡Œï¼Œå½“ç„¶ä»»åŠ¡3ä¹Ÿæ— æ³•æ‰§è¡Œï¼Œåœ¨æ­»å¾ªç¯åçš„ä»»åŠ¡5ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚</p>
<p>æœ€ç»ˆï¼Œåªèƒ½å¾—åˆ°1å’Œ4é¡ºåºä¸å®šçš„ç»“æœã€‚</p>
<p><img src="http://a.hiphotos.baidu.com/image/pic/item/4610b912c8fcc3ce4b64c98b9f45d688d53f20e5.jpg" alt="deadlock5"></p>
<h4 id="æ¡ˆä¾‹å…­ï¼š"><a href="#æ¡ˆä¾‹å…­ï¼š" class="headerlink" title="æ¡ˆä¾‹å…­ï¼š"></a>æ¡ˆä¾‹å…­ï¼š</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">print</span>(<span class="number">0</span>)</div><div class="line"><span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">  <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="string">"sleep 4s..."</span>)</div><div class="line">      sleep(<span class="number">4</span>)</div><div class="line">      <span class="built_in">print</span>(<span class="number">1</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">print</span>(<span class="number">2</span>)</div><div class="line">  <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="number">3</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="number">4</span>)</div><div class="line"><span class="built_in">print</span>(<span class="string">"sleep 8s..."</span>)</div><div class="line">sleep(<span class="number">8</span>)</div></pre></td></tr></table></figure>
<p>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0</div><div class="line">4</div><div class="line">sleep 8s...</div><div class="line">2</div><div class="line">sleep 4s...</div><div class="line">1</div><div class="line">3</div></pre></td></tr></table></figure>
<p>åˆ†æï¼š</p>
<p>é¦–å…ˆæ‰§è¡Œprint(0), ç„¶åä¸»é˜Ÿåˆ—æ·»åŠ å¼‚æ­¥ä»»åŠ¡, ä¸é˜»å¡, æ‰€ä»¥æ‰§è¡Œprint(4), åŠsleep(8)é˜»å¡, ç„¶åå†åˆšæ‰çš„å¼‚æ­¥ä»»åŠ¡å†…, åŒæ ·ä¹Ÿæ˜¯å…ˆæ‰§è¡Œprint(2), ç„¶åå†æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„sleep(4), print(1), print(3).</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/22/iOS-3D-touch/">iOS 3D touch</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jan 22, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <script src="/assets/js/DPlayer.min.js"> </script><p>ç®€å•ä»‹ç»ä¸€ä¸‹iOSä¸­çš„3Dtouch. ä¸€èˆ¬å¼€å‘ä¸­ä¸»è¦æœ‰ä¸‰ç§æƒ…å¢ƒä½¿ç”¨:<br>iconçš„3Dtouch<br>åº”ç”¨å†…çš„é¢„è§ˆ<br>å†å°±æ˜¯å¯èƒ½æ¸¸æˆä¸­ä¼šç”¨åˆ°çš„æŒ‰å‹åŠ›åº¦çš„æ£€æµ‹äº†</p>
<h2 id="iconçš„3D-touch"><a href="#iconçš„3D-touch" class="headerlink" title="iconçš„3D touch"></a>iconçš„3D touch</h2><h3 id="ç¬¬ä¸€ç§æ–¹å¼-åœ¨info-plistä¸­æ·»åŠ "><a href="#ç¬¬ä¸€ç§æ–¹å¼-åœ¨info-plistä¸­æ·»åŠ " class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼: åœ¨info.plistä¸­æ·»åŠ "></a>ç¬¬ä¸€ç§æ–¹å¼: åœ¨info.plistä¸­æ·»åŠ </h3><p><img src="http://oph74zx6j.bkt.clouddn.com/3Dtouch_infoplist.png" alt="3Dtouch with info.plist"></p>
<p>æ•ˆæœå¦‚ä¸‹</p>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/3Dtoucheffect.jpg" width="50%" height="50%"></p>

<p>è§£é‡Šä¸€ä¸‹å…¶ä¸­çš„ä¸€äº›keyçš„æ„æ€:<br><code>UIApplicationShortcutItemIconType</code> æ˜¯ä½¿ç”¨ç³»ç»Ÿæä¾›çš„å›¾æ ‡, ç›®å‰æä¾›äº†è¿‘30ç§å›¾æ ‡<br><code>UIApplicationShortcutItemIconFile</code> æ˜¯ .xcassets æ–‡ä»¶ä¸­è‡ªå®šä¹‰çš„å›¾æ ‡<br><code>UIApplicationShortcutItemType</code> æ˜¯åº”ç”¨é€šè¿‡3Dtouchå¯åŠ¨æ—¶ä¼ ç»™åº”ç”¨å†…éƒ¨çš„è¡¨ç¤º, è®©å†…éƒ¨ä»£ç çŸ¥é“ç‚¹å‡»çš„æ˜¯å“ªä¸ªitem.<br>å…¶ä»–çš„keyæ˜¾è€Œæ˜“è§, ä¸åšè§£é‡Š.</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯åœ¨ä»£ç ä¸­å¤„ç†3Dtouchäº‹ä»¶äº†:<br>1.é¦–å…ˆåº”ç”¨ç¬¬ä¸€æ¬¡å¯åŠ¨:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> launchedShortcutItem: <span class="type">UIApplicationShortcutItem</span>?</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> shortcutItem = launchOptions?[<span class="type">UIApplicationLaunchOptionsKey</span>.shortcutItem] &#123;</div><div class="line">            launchedShortcutItem = shortcutItem <span class="keyword">as</span>? <span class="type">UIApplicationShortcutItem</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.åº”ç”¨å·²ç»å¯åŠ¨, å¹¶ä»åå°3Dtouchå¯åŠ¨:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, </span></span></div><div class="line">                   performActionFor shortcutItem: UIApplicationShortcutItem, </div><div class="line">                   completionHandler: @escaping <span class="params">(Bool)</span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">                   </div><div class="line">    <span class="keyword">let</span> handleAction = handleShortcutItem(shortcutItem)</div><div class="line">    completionHandler(handleAction)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½è·å–äº†shortcutItemçš„ä¿¡æ¯, å°±å¯ä»¥è¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†äº†.</p>
<h3 id="ç”¨ä»£ç åŠ¨æ€æ·»åŠ shortcutItem"><a href="#ç”¨ä»£ç åŠ¨æ€æ·»åŠ shortcutItem" class="headerlink" title="ç”¨ä»£ç åŠ¨æ€æ·»åŠ shortcutItem"></a>ç”¨ä»£ç åŠ¨æ€æ·»åŠ shortcutItem</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> item = <span class="type">UIApplicationShortcutItem</span>(type: <span class="string">"two"</span>,</div><div class="line">                                     localizedTitle: <span class="string">"Phoenix"</span>,</div><div class="line">                                     localizedSubtitle: <span class="string">"Make a Call"</span>,</div><div class="line">                                     icon: <span class="type">UIApplicationShortcutIcon</span>(type: .cloud),</div><div class="line">                                     userInfo: <span class="literal">nil</span>)</div><div class="line">        </div><div class="line"><span class="type">UIApplication</span>.shared.shortcutItems = [item]</div></pre></td></tr></table></figure>
<p>æ³¨æ„: é€šè¿‡info.plist å’Œ ä»£ç æ·»åŠ çš„shortcutItem å¹¶ä¸å†²çª, å–å¹¶é›†, ä½†ç³»ç»Ÿé™åˆ¶æœ€å¤šèƒ½å¤Ÿæ˜¾ç¤º4ä¸ªitem, å› æ­¤ä¼šè‡ªåŠ¨æŒ‰é¡ºåºæˆªå–å‰4ä¸ª.</p>
<h2 id="åº”ç”¨å†…é¢„è§ˆ"><a href="#åº”ç”¨å†…é¢„è§ˆ" class="headerlink" title="åº”ç”¨å†…é¢„è§ˆ"></a>åº”ç”¨å†…é¢„è§ˆ</h2><p>å…ˆçœ‹ä¸€ä¸‹æ•ˆæœå›¾</p>
<p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/3dtouchpeekpop.gif" width="50%" height="50%"></p>

<h3 id="peek-amp-pop"><a href="#peek-amp-pop" class="headerlink" title="peek &amp; pop"></a>peek &amp; pop</h3><p>peekæ˜¯ç”±ä¸€ä¸ªèƒ½å“åº”äº‹ä»¶çš„viewè§¦å‘çš„, éœ€è¦åœ¨viewDidLoadä¸­æ³¨å†Œä»£ç†å’Œæ¥æºè§†å›¾:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidLoad()</div><div class="line">    <span class="keyword">self</span>.registerForPreviewing(with: <span class="keyword">self</span> <span class="keyword">as</span> <span class="type">UIViewControllerPreviewingDelegate</span>, sourceView: <span class="keyword">self</span>.view)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯éµå®ˆåè®®å’Œå®ç°åè®®æ–¹æ³•:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(<span class="number">_</span> previewingContext: UIViewControllerPreviewing, viewControllerForLocation location: CGPoint)</span></span> -&gt; <span class="type">UIViewController</span>? &#123;</div><div class="line">    <span class="comment">// è¿”å›ç›®æ ‡æ§åˆ¶å™¨</span></div><div class="line">    <span class="keyword">let</span> indexPath = <span class="keyword">self</span>.tableView.indexPathForRow(at: location)</div><div class="line">    <span class="keyword">let</span> storyboard = <span class="type">UIStoryboard</span>(name: <span class="string">"Main"</span>, bundle: <span class="literal">nil</span>)</div><div class="line">    <span class="keyword">let</span> content = storyboard.instantiateViewController(withIdentifier: <span class="string">"ContentViewController"</span>) <span class="keyword">as</span>! <span class="type">ContentViewController</span></div><div class="line">    <span class="keyword">guard</span> indexPath != <span class="literal">nil</span> <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> content</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(<span class="number">_</span> previewingContext: UIViewControllerPreviewing, commit viewControllerToCommit: UIViewController)</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.showDetailViewController(viewControllerToCommit, sender: <span class="keyword">self</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="peek-quick-actions"><a href="#peek-quick-actions" class="headerlink" title="peek quick actions"></a>peek quick actions</h3><p>åœ¨ç›®æ ‡æ§åˆ¶å™¨å®ç°ä»¥ä¸‹æ–¹æ³•:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="keyword">var</span> previewActionItems: [<span class="type">UIPreviewActionItem</span>] &#123;</div><div class="line">    <span class="keyword">let</span> action = <span class="type">UIPreviewAction</span>(title: <span class="string">"Save"</span>, style: .<span class="keyword">default</span>) &#123; (action: <span class="type">UIPreviewAction</span>, controller: <span class="type">UIViewController</span>) <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="string">"Save image"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [action]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æŒ‰å‹åŠ›åº¦ç›‘å¬"><a href="#æŒ‰å‹åŠ›åº¦ç›‘å¬" class="headerlink" title="æŒ‰å‹åŠ›åº¦ç›‘å¬"></a>æŒ‰å‹åŠ›åº¦ç›‘å¬</h2><p>å®ç°äº†ä¸€ä¸ªå°demo</p>
<p></p><p style="text-align:center;"><img src="http://oph74zx6j.bkt.clouddn.com/3dtouchweigh.gif" width="50%" height="50%"></p><br>ä»£ç å¦‚ä¸‹:<p></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> touch = touches.first</div><div class="line">    <span class="keyword">self</span>.centerPoint = touch?.location(<span class="keyword">in</span>: touch?.view)</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesMoved</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> touch = touches.first</div><div class="line">    <span class="keyword">let</span> force = touch?.force</div><div class="line">    <span class="keyword">let</span> maximumPossibleForce = touch?.maximumPossibleForce</div><div class="line">    <span class="keyword">let</span> quotient = force! / maximumPossibleForce!</div><div class="line">    <span class="keyword">let</span> border = <span class="keyword">self</span>.view.frame.size.width</div><div class="line">    <span class="keyword">self</span>.round.layer.cornerRadius = border * <span class="number">0.5</span> * quotient</div><div class="line">    <span class="keyword">self</span>.round.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: border * quotient, height: border * quotient)</div><div class="line">    <span class="keyword">let</span> point = touch?.location(<span class="keyword">in</span>: touch?.view)</div><div class="line">    <span class="keyword">self</span>.round.center = point!</div><div class="line">        </div><div class="line">    <span class="keyword">let</span> weight = <span class="number">415</span> * quotient</div><div class="line">    <span class="keyword">self</span>.weightLabel.text = <span class="string">"<span class="subst">\(weight)</span> g"</span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesEnded</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.round.frame = <span class="type">CGRect</span>.zero</div><div class="line">    <span class="keyword">self</span>.weightLabel.text = <span class="string">"0 g"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/Asura19/My30DaysOfSwift/tree/master/3DTouch" target="_blank" rel="external">æœ¬æ–‡å®Œæ•´demo</a> (3Dtouchä¸æ”¯æŒæ¨¡æ‹Ÿå™¨, è¯·ä»¥çœŸæœºè°ƒè¯•)</p>
<p>__åŸåˆ›æ–‡ç« , è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:x.rhythm@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/phoenixnirvana7" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/Asura19" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/phoenix19" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">John Doe</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  <script type="text/html" id="search-result">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">
          <a href="$url$" class="post-link">
            $title$
          </a>
        </h1>
      </header>
      <div class="post-content">
        $content$
        <div class="read-more">
          <a href="$url$" class="read-more-link">
            Read more..
          </a>
        </div>
      </div>
    </article>
  </script>
  <script type="text/html" id="no-search-result">
    <div class="no-result">
      <h2>No result found!</h2>
    </div>
  </script>
  <script type="text/javascript" src="/js/src/search.js?v=2.4.x"></script>

  </body>
</html>
